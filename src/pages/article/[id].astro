---
import Layout from "../../Layouts/Layout.astro";
import ArticleHeader from "../../components/article/ArticleHeader.astro";
import ArticleAuthor from "../../components/article/ArticleAuthor.astro";
import ArticleDate from "@/components/article/ArticleDate.astro";
import SocialShare from "../../components/article/SocialShare.astro";
import ArticleImage from "../../components/article/ArticleImage.astro";
import ArticleBody from "../../components/article/ArticleBody.astro";
import ArticleTips from "../../components/article/ArticleTips.astro";
import RecentArticles from "../../components/article/RecentArticles.astro";
import EventDetails from "../../components/article/EventDetails.astro";
import type { ImageMetadata } from "astro";
import { newsItems } from "@/content/mockNews";
import { ApiError, articlesApi } from "@/lib/api/api";

const { id } = Astro.params;

const CATEGORY_LABELS: Record<string, string> = {
  culture: "Культура",
  paris: "Париж",
  hotContent: "Самое Читаемое",
};

let articleData: any;
let error: string | null = null;

try {
  articleData = await articlesApi.getById(id);
} catch (e: any) {
  console.error(e);
  if (e instanceof ApiError) {
    error =
      e.status === 404
        ? "Article not found."
        : `Error fetching article: ${e.message}`;
  } else {
    error = `Error fetching article: ${e.message}`;
  }
}

// Normalize data for the template
const rawCategory =
  articleData?.category ?? articleData?.header?.category ?? null;

const displayArticle = {
  title: articleData?.header?.title || articleData?.title || 'Article',
  lead: articleData?.lead || '',
  category: rawCategory
    ? CATEGORY_LABELS[rawCategory] || rawCategory
    : 'Category',
  authorName: articleData?.author ? `${articleData.author.firstName} ${articleData.author.lastName}` : 'Author',
  authorAvatar: articleData?.author?.avatar,
  readTime: articleData?.meta?.readTime || '5 min read',
  imageUrl: articleData?.imageUrl, // For dynamic articles
  imageCaption: articleData?.imageCaption || '', // <-- Get the caption
  imageAlt: articleData?.mainImage?.alt || 'Article image',
  contentBlocks: articleData?.content || [],
  tips: Array.isArray(articleData?.tips) ? articleData.tips : [],
};

const transitionAliases = [`landing-body-main-article-image-${id}`];
---

<Layout
  navbarVariant="default"
  includePreFooterCTA={false}
  title={`${displayArticle.title} - Maag`}
  useClientRouter={true}
>
  <main class="bg-base-200 min-h-screen">
    <div class="max-w-[1512px] mx-auto">
      {error && <div class="text-red-500 text-center pt-40">{error}</div>}
      {!error && articleData && (
        <>
          <!-- Article Header Section -->
          <div class="pt-[50px] pb-[70px] flex flex-col items-center gap-[50px]">
            <div class="flex flex-col gap-4 max-w-[825px] w-full">
              <ArticleHeader
                category={displayArticle.category}
                title={displayArticle.title}
                lead={displayArticle.lead}
              />
              <div class="flex flex-row items-center justify-start gap-4">
                <ArticleAuthor
                  name={displayArticle.authorName}
                  avatarUrl={displayArticle.authorAvatar}
                />
                <div>·</div>
                <ArticleDate createdAt={articleData.createdAt} />
                {/* <SocialShare readTime={displayArticle.readTime} /> */}
              </div>
            </div>

            {displayArticle.imageUrl && (
              <ArticleImage
                src={displayArticle.imageUrl}
                alt={displayArticle.imageAlt}
                caption={displayArticle.imageCaption}
                transitionName={`main-article-image-${id}`}
                transitionAliases={transitionAliases}
                figureClass="max-w-[1200px]"
                imageClass="shadow-lg"
                figcaptionClass="text-center font-oswald text-sm text-gray-500 mt-2"
              />
            )}
          </div>

          <!-- Article Content -->
          <div class="max-w-[1400px] mx-auto px-14 pb-[100px]">
            <ArticleBody contentBlocks={displayArticle.contentBlocks} />
            <ArticleTips tips={displayArticle.tips} />
            
            {/* Conditionally render EventDetails only if the data exists */}
            {(articleData?.eventDetails) && (
              <EventDetails
                address={articleData.eventDetails.address}
                dates={articleData.eventDetails.dates}
              />
            )}
            
            {/* RecentArticles component removed as per user instruction to remove all static logic */}
          </div>
        </>
      )}
    </div>
  </main>
</Layout>
