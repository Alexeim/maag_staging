---
import Layout from "../../Layouts/Layout.astro";
import ArticleHeader from "../../components/article/ArticleHeader.astro";
import ArticleAuthor from "../../components/article/ArticleAuthor.astro";
import SocialShare from "../../components/article/SocialShare.astro";
import ArticleImage from "../../components/article/ArticleImage.astro";
import ArticleBody from "../../components/article/ArticleBody.astro";
import RecentArticles from "../../components/article/RecentArticles.astro";
import EventDetails from "../../components/article/EventDetails.astro";
import articleData from "../../content/articlePage/RU/Article.json";
import type { ImageMetadata } from "astro";
import { newsItems } from "@/content/mockNews";

export async function getStaticPaths() {
  // Add the main article to the list for static path generation
  const allArticles = [...newsItems, { id: "main-article" }];
  return allArticles.map((item) => ({
    params: { id: item.id },
  }));
}

const { id } = Astro.params;

// Determine the transition name based on the ID
const transitionName = id === "main-article" ? "main-article-image" : `news-image-${id}`;

// Import all article images at once!
const images = import.meta.glob<{ default: ImageMetadata }>(
  "/src/assets/images/article_content/*.{jpeg,jpg,png,gif}",
  { eager: true }
);

// Prepare data with resolved image modules
const mainImageModule =
  images[`/src/assets/images/article_content/${articleData.mainImage.src}`]
    ?.default;

const relatedArticlesWithImages = await Promise.all(
  articleData.relatedArticles.map(async (article) => {
    const imageModule =
      images[`/src/assets/images/article_content/${article.image}`]?.default;
    return { ...article, image: imageModule };
  })
);
---

<Layout
  navbarVariant="default"
  includePreFooterCTA={false}
  title={`${articleData.header.title} - Maag`}
  useClientRouter={true}
>
  <main class="bg-base-200 min-h-screen">
    <div class="max-w-[1512px] mx-auto">
      <!-- Article Header Section -->
      <div class="pt-[150px] pb-[100px] flex flex-col items-center gap-[100px]">
        <div class="flex flex-col gap-8 max-w-[825px] w-full">
          <ArticleHeader
            category={articleData.header.category}
            title={articleData.header.title}
          />
          <ArticleAuthor
            name={articleData.author.name}
            avatarUrl={articleData.author.avatarUrl}
          />
          <SocialShare readTime={articleData.meta.readTime} />
        </div>

        {
          mainImageModule && (
            <ArticleImage
              src={mainImageModule}
              alt={articleData.mainImage.alt}
              caption={articleData.mainImage.caption}
              transitionName={transitionName}
            />
          )
        }
      </div>

      <!-- Article Content -->
      <div class="max-w-[1400px] mx-auto px-14 pb-[100px]">
        <ArticleBody
          opening={articleData.bodyDefault.opening}
          sections={articleData.bodyDefault.sections}
        />
        <EventDetails
          address={articleData.eventDetails.address}
          dates={articleData.eventDetails.dates}
        />
        <RecentArticles articles={relatedArticlesWithImages} />
      </div>
    </div>
  </main>
</Layout>
