---
import Layout from "../../Layouts/Layout.astro";
import ArticleHeader from "../../components/article/ArticleHeader.astro";
import ArticleAuthor from "../../components/article/ArticleAuthor.astro";
import SocialShare from "../../components/article/SocialShare.astro";
import ArticleImage from "../../components/article/ArticleImage.astro";
import ArticleBody from "../../components/article/ArticleBody.astro";
import RecentArticles from "../../components/article/RecentArticles.astro";
import EventDetails from "../../components/article/EventDetails.astro";
import type { ImageMetadata } from "astro";
import { newsItems } from "@/content/mockNews";
import { PUBLIC_API_BASE_URL } from "@/lib/utils/constants";

const { id } = Astro.params;

let articleData: any;
let error: string | null = null;

try {
  const response = await fetch(`${PUBLIC_API_BASE_URL}/api/articles/${id}`);
  if (response.ok) {
    articleData = await response.json();
  } else {
    error = `Article not found. Status: ${response.status}`;
  }
} catch (e: any) {
  console.error(e);
  error = `Error fetching article: ${e.message}`;
}

// Normalize data for the template
const displayArticle = {
  title: articleData?.header?.title || articleData?.title || 'Article',
  category: articleData?.header?.category || 'Category',
  authorName: articleData?.author ? `${articleData.author.firstName} ${articleData.author.lastName}` : 'Author',
  authorAvatar: articleData?.author?.avatarUrl,
  readTime: articleData?.meta?.readTime || '5 min read',
  imageUrl: articleData?.imageUrl, // For dynamic articles
  imageAlt: articleData?.mainImage?.alt || 'Article image',
  imageCaption: articleData?.mainImage?.caption || '',
  // For static article
  bodyOpening: articleData?.bodyDefault?.opening,
  bodySections: articleData?.bodyDefault?.sections,
};

// Prepare props for ArticleBody for dynamic articles
let dynamicOpening = "";
let dynamicSections: { type: 'paragraph'; content: string }[] = [];

if (id !== 'main-article' && articleData && articleData.content) {
  const paragraphs = articleData.content
    .filter(block => block.type === 'paragraph')
    .map(block => block.text);
  
  if (paragraphs.length > 0) {
    dynamicOpening = paragraphs[0];
  }
  if (paragraphs.length > 1) {
    dynamicSections = paragraphs.slice(1).map(p => ({ type: 'paragraph', content: p }));
  }
}
---

<Layout
  navbarVariant="default"
  includePreFooterCTA={false}
  title={`${displayArticle.title} - Maag`}
  useClientRouter={true}
>
  <main class="bg-base-200 min-h-screen">
    <div class="max-w-[1512px] mx-auto">
      {error && <div class="text-red-500 text-center pt-40">{error}</div>}
      {!error && articleData && (
        <>
          <!-- Article Header Section -->
          <div class="pt-[150px] pb-[100px] flex flex-col items-center gap-[100px]">
            <div class="flex flex-col gap-8 max-w-[825px] w-full">
              <ArticleHeader
                category={displayArticle.category}
                title={displayArticle.title}
              />
              <ArticleAuthor
                name={displayArticle.authorName}
                avatarUrl={displayArticle.authorAvatar}
              />
              <SocialShare readTime={displayArticle.readTime} />
            </div>

            {id !== 'main-article' && displayArticle.imageUrl && (
               <img 
                  src={displayArticle.imageUrl} 
                  alt={displayArticle.imageAlt} 
                  class="w-full h-auto max-w-[1200px] rounded-lg shadow-lg"
                  transition:name={`main-article-image-${id}`}
                />
            )}
          </div>

          <!-- Article Content -->
          <div class="max-w-[1400px] mx-auto px-14 pb-[100px]">
            {id === 'main-article' ? (
              <ArticleBody
                opening={displayArticle.bodyOpening}
                sections={displayArticle.bodySections}
              />
            ) : (
              <ArticleBody
                opening={dynamicOpening}
                sections={dynamicSections}
              />
            )}
            
            {/* Conditionally render EventDetails only if the data exists */}
            {(articleData?.eventDetails) && (
              <EventDetails
                address={articleData.eventDetails.address}
                dates={articleData.eventDetails.dates}
              />
            )}
            
            {/* RecentArticles component removed as per user instruction to remove all static logic */}
          </div>
        </>
      )}
    </div>
  </main>
</Layout>
