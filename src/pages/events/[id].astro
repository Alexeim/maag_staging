---
import Layout from "../../Layouts/Layout.astro";
import ArticleHeader from "../../components/article/ArticleHeader.astro";
import ArticleImage from "../../components/article/ArticleImage.astro";
import ArticleBody from "../../components/article/ArticleBody.astro";
import EventDetails from "../../components/article/EventDetails.astro";
import { ApiError, eventsApi } from "@/lib/api/api";

const { id } = Astro.params;

const CATEGORY_LABELS: Record<string, string> = {
  exhibition: "Выставка",
  concert: "Концерт",
  performance: "Спектакль",
};

const toDate = (value: unknown): Date | null => {
  if (!value) {
    return null;
  }
  if (value instanceof Date) {
    return value;
  }
  if (typeof value === "string") {
    const parsed = new Date(value);
    return Number.isNaN(parsed.getTime()) ? null : parsed;
  }
  if (typeof value === "number") {
    const parsed = new Date(value);
    return Number.isNaN(parsed.getTime()) ? null : parsed;
  }
  if (typeof value === "object") {
    const maybeSeconds =
      (value as { _seconds?: number; seconds?: number })._seconds ??
      (value as { _seconds?: number; seconds?: number }).seconds;
    if (typeof maybeSeconds === "number") {
      return new Date(maybeSeconds * 1000);
    }
  }
  return null;
};

const formatDateRange = (start: Date | null, end: Date | null): string | null => {
  if (!start) {
    return null;
  }
  const format = (date: Date) =>
    date.toLocaleDateString("ru-RU", {
      day: "numeric",
      month: "long",
      year: "numeric",
    });

  if (!end || start.getTime() === end.getTime()) {
    return format(start);
  }

  return `${format(start)} — ${format(end)}`;
};

const formatTimeLabel = (event: any): string | null => {
  const mode =
    event?.timeMode === "start" || event?.timeMode === "range" ? event.timeMode : "none";
  const start = typeof event?.startTime === "string" ? event.startTime.trim() : "";
  const end = typeof event?.endTime === "string" ? event.endTime.trim() : "";
  if (mode === "start" && start) {
    return `Начало в ${start}`;
  }
  if (mode === "range" && start && end) {
    return `${start} — ${end}`;
  }
  return null;
};

const normalizeTags = (value: unknown): string[] => {
  if (!Array.isArray(value)) {
    return [];
  }
  return value
    .map((item) => (typeof item === "string" ? item.trim() : ""))
    .filter(Boolean);
};

let eventData: any;
let error: string | null = null;

try {
  eventData = await eventsApi.getById(id);
} catch (e: any) {
  console.error(e);
  if (e instanceof ApiError) {
    error =
      e.status === 404
        ? "Событие не найдено."
        : `Ошибка загрузки события: ${e.message}`;
  } else {
    error = `Ошибка загрузки события: ${e.message}`;
  }
}

const startDate = toDate(eventData?.startDate);
const endDate = toDate(eventData?.endDate);
const tags = normalizeTags(eventData?.tags);
const techTags = normalizeTags(eventData?.techTags);
const allTags = [...tags, ...techTags];

const displayEvent = {
  title: eventData?.title || "Событие",
  lead: eventData?.lead || "",
  category: eventData?.category ? CATEGORY_LABELS[eventData.category] || eventData.category : "Событие",
  imageUrl: eventData?.imageUrl,
  imageCaption: eventData?.imageCaption || "",
  imageAlt: eventData?.mainImage?.alt || "Изображение события",
  contentBlocks: eventData?.content || [],
  address:
    typeof eventData?.address === "string" && eventData.address.trim().length > 0
      ? eventData.address
      : "Место уточняется",
  datesLabel: formatDateRange(startDate, endDate),
  timeLabel: formatTimeLabel(eventData),
};
---

<Layout
  navbarVariant="default"
  includePreFooterCTA={false}
  title={`${displayEvent.title} - Maag`}
  useClientRouter={true}
>
  <main class="bg-base-200 min-h-screen">
    <div class="max-w-[1512px] mx-auto">
      {error && <div class="text-red-500 text-center pt-40">{error}</div>}
      {!error && eventData && (
        <>
          <div class="pt-[150px] pb-[70px] flex flex-col items-center gap-[56px]">
            <div class="flex flex-col gap-8 max-w-[825px] w-full px-4">
              <ArticleHeader
                category={displayEvent.category}
                title={displayEvent.title}
                lead={displayEvent.lead}
              />
              <div class="flex flex-wrap gap-2">
                {allTags.map((tag) => (
                  <span class="px-3 py-1 rounded-full bg-base-300 text-sm">{tag}</span>
                ))}
              </div>
              {displayEvent.datesLabel && (
                <div class="text-sm text-base-content/70 uppercase tracking-[0.2em]">
                  {displayEvent.datesLabel}
                </div>
              )}
            </div>

            {displayEvent.imageUrl && (
              <ArticleImage
                src={displayEvent.imageUrl}
                alt={displayEvent.imageAlt}
                caption={displayEvent.imageCaption}
                transitionName={`event-image-${id}`}
                figureClass="max-w-[1200px]"
                imageClass="shadow-lg rounded-lg"
              />
            )}
          </div>

          <div class="max-w-[1400px] mx-auto px-4 lg:px-14 pb-[100px]">
            <ArticleBody contentBlocks={displayEvent.contentBlocks} />

            {displayEvent.datesLabel && (
              <EventDetails
                address={displayEvent.address}
                dates={displayEvent.datesLabel}
                time={displayEvent.timeLabel}
              />
            )}
          </div>
        </>
      )}
    </div>
  </main>
</Layout>
