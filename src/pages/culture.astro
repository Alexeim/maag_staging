---
import Layout from "../Layouts/Layout.astro";
import picture1 from "../assets/images/culture.jpg";
import { articlesApi, interviewsApi, flippersApi } from "@/lib/api/api";

const CATEGORY_LABELS: Record<string, string> = {
  culture: "Культура",
  hotContent: "Самое Читаемое",
};

const CULTURE_CATEGORY_KEY = "culture";
const HOT_CONTENT_CATEGORY_KEY = "hotContent";

const normalizeCategory = (value?: string) => {
  if (!value) return null;
  const lowerCaseValue = value.toLowerCase().trim();
  const entry = Object.entries(CATEGORY_LABELS).find(
    ([key, label]) =>
      key.toLowerCase() === lowerCaseValue ||
      label.toLowerCase() === lowerCaseValue,
  );
  return entry ? entry[0] : lowerCaseValue;
};

const TAG_LABEL_ALIASES: Record<string, string> = {
  exhibition: "Выставка",
  exhibitions: "Выставка",
  concert: "Концерт",
  concerts: "Концерт",
  performance: "Спектакль",
  performances: "Спектакль",
  theatre: "Театр",
  theater: "Театр",
  theatres: "Театры",
  theaters: "Театры",
  culture: "Культура",
  paris: "Париж",
};

const isHotContent = (item: any) =>
  Boolean(item?.isHotContent) ||
  normalizeCategory(item?.category) === HOT_CONTENT_CATEGORY_KEY;

const isMainInCategoryItem = (item: any) =>
  item?.isMainInCategory === true ||
  item?.isMainInCategory === "true" ||
  item?.isMainInCategory === 1 ||
  item?.isMainInCategory === "1";

const getDate = (timestamp: any): Date => {
  if (timestamp instanceof Date) {
    return timestamp;
  }
  if (timestamp && typeof timestamp === "object" && "_seconds" in timestamp) {
    return new Date((timestamp as { _seconds: number })._seconds * 1000);
  }
  return new Date(timestamp);
};

const formatDate = (value: unknown) => {
  const date = getDate(value);
  if (Number.isNaN(date.getTime())) {
    return "";
  }
  return date
    .toLocaleDateString("ru-RU", {
      day: "2-digit",
      month: "long",
      year: "numeric",
    })
    .replace(" г.", "");
};

const normalizeTags = (value: unknown): string[] => {
  if (!Array.isArray(value)) {
    return [];
  }
  return value
    .map((tag) => (typeof tag === "string" ? tag.trim() : ""))
    .filter(Boolean);
};

const getPrimaryTag = (item: any): string => {
  if (item?.contentType === "interview") {
    return "Интервью";
  }
  if (item?.isNews) {
    return "Новости";
  }
  const tags = normalizeTags(item?.tags);
  if (tags.length === 0) {
    return "";
  }
  const firstTag = tags[0];
  const normalized = firstTag.toLowerCase();
  return TAG_LABEL_ALIASES[normalized] ?? firstTag;
};

const toContentHref = (item: any) => {
  if (item?.contentType === "interview") {
    return `/interviews/${item.id}`;
  }
  if (item?.contentType === "flipper") {
    return `/flippers/${item.id}`;
  }
  return `/${item?.isNews ? "news" : "article"}/${item.id}`;
};

const truncateText = (text?: string, maxLength: number = 220) => {
  if (!text) return "";
  if (text.length <= maxLength) return text;
  return `${text.slice(0, maxLength).trim()}...`;
};

const getTransitionName = (item: any) => {
  if (!item?.id) {
    return undefined;
  }
  const href = typeof item?.href === "string" ? item.href : "";
  if (href.startsWith("/events/")) {
    return `event-image-${item.id}`;
  }
  if (
    href.startsWith("/article/") ||
    href.startsWith("/news/") ||
    href.startsWith("/interviews/")
  ) {
    return `main-article-image-${item.id}`;
  }
  return undefined;
};

let primaryCultureArticle: any = null;
let secondaryCultureArticle: any = null;
let cultureFeed: any[] = [];
let hotContentItems: any[] = [];

try {
  const [articles, interviews, flippers] = await Promise.all([
    articlesApi.list(),
    interviewsApi.list(),
    flippersApi.list(),
  ]);

  const allContent = [
    ...articles.map((article) => ({
      ...article,
      contentType: "article",
      tags: normalizeTags(article?.tags),
    })),
    ...interviews.map((interview) => ({
      ...interview,
      contentType: "interview",
      category: "culture",
      tags: normalizeTags(interview?.tags),
    })),
    ...flippers.map((flipper) => ({
      ...flipper,
      contentType: "flipper",
      imageUrl: flipper?.carouselContent?.[0]?.imageUrl || null,
      tags: normalizeTags(flipper?.tags),
    })),
  ];

  const sortedContent = [...allContent].sort(
    (a, b) => getDate(b.createdAt).getTime() - getDate(a.createdAt).getTime(),
  );

  const cultureItems = sortedContent
    .filter(
      (article) =>
        normalizeCategory(article.category) === CULTURE_CATEGORY_KEY &&
        !isHotContent(article),
    )
    .map((article) => ({
      ...article,
      href: toContentHref(article),
    }));

  primaryCultureArticle =
    cultureItems.find((item) => isMainInCategoryItem(item)) ??
    cultureItems[0] ??
    null;

  const cultureWithoutPrimary = cultureItems.filter((item) =>
    primaryCultureArticle ? item.id !== primaryCultureArticle.id : true,
  );

  secondaryCultureArticle = cultureWithoutPrimary[0] ?? null;
  cultureFeed = cultureWithoutPrimary.slice(1);

  hotContentItems = sortedContent
    .filter((article) => isHotContent(article))
    .map((article) => ({
      ...article,
      href: toContentHref(article),
    }))
    .slice(0, 6);
} catch (error) {
  console.error("Failed to fetch culture page articles:", error);
}
---

<Layout
  navbarVariant="default"
  includePreFooterCTA={false}
  title="Культура - Maag"
  useClientRouter={true}
>
  <main class="bg-base-200 min-h-screen pb-16">
    <section class="max-w-[1400px] mx-auto px-4 lg:px-8 pt-8 lg:pt-12">
      <div class="border-b border-base-content/25 pb-6">
        <h1 class="text-4xl lg:text-6xl font-oswald font-thin leading-none">
          Культура
        </h1>
      </div>

      <section
        class="mt-8 lg:mt-10 grid grid-cols-1 lg:grid-cols-[0.9fr_1.55fr_1fr] gap-6 lg:gap-7"
      >
        <aside class="lg:pr-4 lg:border-r lg:border-base-content/15">
          <h2
            class="text-xs uppercase tracking-[0.35em] text-error font-inter mb-4"
          >
            {CATEGORY_LABELS[HOT_CONTENT_CATEGORY_KEY]}
          </h2>

          {
            hotContentItems.length > 0 ? (
              <div class="flex gap-4 overflow-x-auto pb-3 -mx-1 px-1 lg:block lg:overflow-visible lg:pb-0 lg:mx-0 lg:px-0 lg:divide-y lg:divide-base-content/15 lg:border-y lg:border-base-content/20">
                {hotContentItems.map((item) => (
                  <article class="min-w-[270px] max-w-[270px] flex-shrink-0 border border-base-content/20 p-3 grid grid-cols-[minmax(0,1fr)_72px] gap-3 items-start lg:min-w-0 lg:max-w-none lg:border-0 lg:p-0 lg:py-4 lg:grid-cols-[minmax(0,1fr)_84px]">
                    <div>
                      <a href={item.href} class="block">
                        <h4 class="text-2xl lg:text-[34px] leading-[1.06] font-oswald font-thin hover:underline">
                          {item.title}
                        </h4>
                      </a>
                      {item.lead && (
                        <p class="mt-2 text-sm leading-relaxed text-base-content/75 font-oswald font-thin tracking-wide">
                          {truncateText(item.lead, 95)}
                        </p>
                      )}
                      <div class="mt-3 flex items-center gap-2 text-[11px] font-inter uppercase tracking-[0.18em] text-base-content/50">
                        {getPrimaryTag(item) && (
                          <>
                            <span class="text-[10px] font-medium uppercase tracking-[0.22em] text-error">
                              {getPrimaryTag(item)}
                            </span>
                            <span class="text-base-content/45">·</span>
                          </>
                        )}
                        <span>{formatDate(item.createdAt)}</span>
                      </div>
                    </div>
                    <a
                      href={item.href}
                      class="block overflow-hidden mt-1 transition-opacity duration-200 hover:opacity-90"
                    >
                      <img
                        src={item.imageUrl || picture1.src}
                        alt={item.title}
                        class="w-[72px] h-[72px] lg:w-[84px] lg:h-[84px] object-cover object-center"
                        loading="lazy"
                        transition:name={getTransitionName(item)}
                      />
                    </a>
                  </article>
                ))}
              </div>
            ) : (
              <p class="text-sm text-base-content/70 font-oswald font-thin tracking-wide">
                Пока нет материалов в блоке hot content.
              </p>
            )
          }
        </aside>

        <div class="lg:pr-4 lg:border-r lg:border-base-content/15">
          {
            primaryCultureArticle ? (
              <article>
                <a
                  href={primaryCultureArticle.href}
                  class="block overflow-hidden transition-opacity duration-200 hover:opacity-90"
                >
                  <img
                    src={primaryCultureArticle.imageUrl || picture1.src}
                    alt={primaryCultureArticle.title}
                    class="w-full h-[320px] lg:h-[560px] object-cover object-center"
                    loading="lazy"
                    transition:name={getTransitionName(primaryCultureArticle)}
                  />
                </a>
                <a href={primaryCultureArticle.href} class="block mt-5">
                  <h2 class="text-3xl lg:text-[52px] leading-[1.02] font-oswald font-thin hover:underline">
                    {primaryCultureArticle.title}
                  </h2>
                </a>
                {primaryCultureArticle.lead && (
                  <p class="mt-3 text-lg leading-relaxed text-base-content/80 font-oswald font-thin tracking-wide">
                    {truncateText(primaryCultureArticle.lead, 220)}
                  </p>
                )}
                <div class="mt-4 flex items-center gap-2 text-xs font-inter uppercase tracking-[0.22em] text-base-content/55">
                  {getPrimaryTag(primaryCultureArticle) && (
                    <>
                      <span class="text-[10px] font-medium uppercase tracking-[0.24em] text-error">
                        {getPrimaryTag(primaryCultureArticle)}
                      </span>
                      <span class="text-base-content/45">·</span>
                    </>
                  )}
                  <span>{formatDate(primaryCultureArticle.createdAt)}</span>
                </div>
              </article>
            ) : (
              <article class="border border-base-content/15 p-6">
                <p class="text-base-content/70 font-oswald font-thin tracking-wide">
                  Пока нет материалов категории «Культура».
                </p>
              </article>
            )
          }
        </div>

        <div class="lg:pr-4 lg:border-r lg:border-base-content/15">
          {
            secondaryCultureArticle ? (
              <article>
                <a
                  href={secondaryCultureArticle.href}
                  class="block overflow-hidden transition-opacity duration-200 hover:opacity-90"
                >
                  <img
                    src={secondaryCultureArticle.imageUrl || picture1.src}
                    alt={secondaryCultureArticle.title}
                    class="w-full h-[320px] lg:h-[420px] object-cover object-center"
                    loading="lazy"
                    transition:name={getTransitionName(secondaryCultureArticle)}
                  />
                </a>
                <a href={secondaryCultureArticle.href} class="block mt-5">
                  <h3 class="text-3xl lg:text-[46px] leading-[1.05] font-oswald font-thin hover:underline">
                    {secondaryCultureArticle.title}
                  </h3>
                </a>
                {secondaryCultureArticle.lead && (
                  <p class="mt-3 text-lg leading-relaxed text-base-content/80 font-oswald font-thin tracking-wide">
                    {truncateText(secondaryCultureArticle.lead, 180)}
                  </p>
                )}
                <div class="mt-4 flex items-center gap-2 text-xs font-inter uppercase tracking-[0.22em] text-base-content/55">
                  {getPrimaryTag(secondaryCultureArticle) && (
                    <>
                      <span class="text-[10px] font-medium uppercase tracking-[0.24em] text-error">
                        {getPrimaryTag(secondaryCultureArticle)}
                      </span>
                      <span class="text-base-content/45">·</span>
                    </>
                  )}
                  <span>{formatDate(secondaryCultureArticle.createdAt)}</span>
                </div>
              </article>
            ) : (
              <article class="border border-base-content/15 p-6">
                <p class="text-base-content/70 font-oswald font-thin tracking-wide">
                  Добавьте еще один материал в культуру для второго блока.
                </p>
              </article>
            )
          }
        </div>
      </section>

      <section class="mt-10 lg:mt-14 border-t border-base-content/25 pt-8">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-x-7 gap-y-10">
          {
            cultureFeed.map((item) => (
              <article class="border-b border-base-content/15 pb-6">
                <a
                  href={item.href}
                  class="block overflow-hidden transition-opacity duration-200 hover:opacity-90"
                >
                  <img
                    src={item.imageUrl || picture1.src}
                    alt={item.title}
                    class="w-full h-[220px] lg:h-[250px] object-cover object-center"
                    loading="lazy"
                    transition:name={getTransitionName(item)}
                  />
                </a>
                <a href={item.href} class="block mt-4">
                  <h3 class="text-3xl lg:text-[40px] leading-[1.04] font-oswald font-thin hover:underline">
                    {item.title}
                  </h3>
                </a>
                {item.lead && (
                  <p class="mt-3 text-base leading-relaxed text-base-content/75 font-oswald font-thin tracking-wide">
                    {truncateText(item.lead, 190)}
                  </p>
                )}
                <div class="mt-4 flex items-center gap-2 text-xs font-inter uppercase tracking-[0.2em] text-base-content/55">
                  {getPrimaryTag(item) && (
                    <>
                      <span class="text-[10px] font-medium uppercase tracking-[0.24em] text-error">
                        {getPrimaryTag(item)}
                      </span>
                      <span class="text-base-content/45">·</span>
                    </>
                  )}
                  <span>{formatDate(item.createdAt)}</span>
                </div>
              </article>
            ))
          }
        </div>
      </section>
    </section>
  </main>
</Layout>
