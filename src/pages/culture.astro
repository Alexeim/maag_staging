---
import LandingBody from "@/components/common/LandingBody.astro";
import Layout from "../Layouts/Layout.astro";
import eric from "../assets/common/image.jpg";
import logoFull from "../assets/logo/logoFull.svg";
import { Image } from "astro:assets";
import CategoryHero from "@/components/common/CategoryHero.astro";
import ArticleCard from "@/components/common/ArticleCard.astro";
import { articlesApi, flippersApi, type FlipperPayload } from "@/lib/api/api";

interface FlipperResponse extends FlipperPayload {
  id: string;
  createdAt: string | Date;
}

// Helper function to convert Firebase Timestamp to Date
const getDate = (timestamp: any): Date => {
  if (timestamp instanceof Date) {
    return timestamp;
  }
  if (timestamp && typeof timestamp === 'object' && '_seconds' in timestamp) {
    return new Date(timestamp._seconds * 1000);
  }
  return new Date(timestamp);
};

const normalizeCategory = (value?: string) => {
  if (!value) return null;
  return value.toLowerCase().trim();
};

const isHotContent = (item: any) =>
  Boolean(item?.isHotContent) || normalizeCategory(item?.category) === 'hotcontent';

const getPrimaryTag = (item: any) => {
  const rawTags = Array.isArray(item?.tags) ? item.tags : (typeof item?.tags === 'string' ? [item.tags] : []);
  const firstTag = rawTags.find((tag: string) => typeof tag === 'string' && tag.trim().length > 0);
  if (firstTag) return firstTag.trim();
  return item?.category || 'Культура';
};

let mainInCategoryArticle: any = null;
let cultureArticles: any[] = [];

try {
  const articles = await articlesApi.list();

  const rawCultureArticles = articles
    .map(article => ({ ...article, type: 'article', href: `/article/${article.id}` }))
    .filter(article => normalizeCategory(article.category) === 'culture')
    .sort((a, b) => getDate(b.createdAt).getTime() - getDate(a.createdAt).getTime());

  // Find the main article for this category
  mainInCategoryArticle = rawCultureArticles.find(article => article.isMainInCategory) || null;

  // Filter out the main article from the rest, and also hot content (as per original logic for other items)
  // If mainInCategoryArticle exists, it's also filtered out from this list
  cultureArticles = rawCultureArticles.filter(article =>
    (mainInCategoryArticle ? article.id !== mainInCategoryArticle.id : true) && !isHotContent(article)
  );

} catch (error) {
  console.error("Failed to fetch culture articles:", error);
}

const itemsToShow = cultureArticles.slice(0); // All remaining culture articles

// Split remaining items into rows of 3
const itemsPerRow = 3;
const cultureRows: any[][] = [];
for (let i = 0; i < itemsToShow.length; i += itemsPerRow) {
  cultureRows.push(itemsToShow.slice(i, i + itemsPerRow));
}
---

<Layout
  navbarVariant="default"
  includePreFooterCTA={false}
  title="Maag"
  useClientRouter={true}
>
  <CategoryHero title={"Культура"} article={mainInCategoryArticle} />

  {cultureRows.map((row) => (
    <div id="culture-articles-box" class="w-full flex flex-col gap-6 lg:flex-row lg:gap-8 items-stretch justify-start py-8 px-2 lg:px-4 min-h-[100px]">
      {row.map((item) => (
        <ArticleCard
          key={item.id}
          isNetlenka={false}
          title={item.title}
          category={getPrimaryTag(item)}
          imageUrl={item.imageUrl}
          href={item.href}
        />
      ))}
      {row.length < itemsPerRow && Array.from({ length: itemsPerRow - row.length }).map((_, i) => (
        <ArticleCard key={`placeholder-${i}`} isNetlenka={false} />
      ))}
    </div>
  ))}
</Layout>
