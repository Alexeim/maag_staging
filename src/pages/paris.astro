---
import Layout from "../Layouts/Layout.astro";
import picture1 from "../assets/images/culture.jpg";
import { articlesApi } from "@/lib/api/api";

const CATEGORY_LABELS: Record<string, string> = {
  paris: "Париж",
  hotContent: "Самое Читаемое",
};

const PARIS_CATEGORY_KEY = "paris";
const HOT_CONTENT_CATEGORY_KEY = "hotContent";

const normalizeCategory = (value?: string) => {
  if (!value) return null;
  const lowerCaseValue = value.toLowerCase().trim();
  const entry = Object.entries(CATEGORY_LABELS).find(
    ([key, label]) =>
      key.toLowerCase() === lowerCaseValue ||
      label.toLowerCase() === lowerCaseValue,
  );
  return entry ? entry[0] : lowerCaseValue;
};

const isHotContent = (item: any) =>
  Boolean(item?.isHotContent) ||
  normalizeCategory(item?.category) === HOT_CONTENT_CATEGORY_KEY;

const isMainInCategoryItem = (item: any) =>
  item?.isMainInCategory === true ||
  item?.isMainInCategory === "true" ||
  item?.isMainInCategory === 1 ||
  item?.isMainInCategory === "1";

const getDate = (timestamp: any): Date => {
  if (timestamp instanceof Date) {
    return timestamp;
  }
  if (timestamp && typeof timestamp === "object" && "_seconds" in timestamp) {
    return new Date((timestamp as { _seconds: number })._seconds * 1000);
  }
  return new Date(timestamp);
};

const formatDate = (value: unknown) => {
  const date = getDate(value);
  if (Number.isNaN(date.getTime())) {
    return "";
  }
  return date.toLocaleDateString("ru-RU", {
    day: "2-digit",
    month: "long",
    year: "numeric",
  });
};

const toArticleHref = (article: any) =>
  `/${article?.isNews ? "news" : "article"}/${article.id}`;

const truncateText = (text?: string, maxLength: number = 220) => {
  if (!text) return "";
  if (text.length <= maxLength) return text;
  return `${text.slice(0, maxLength).trim()}...`;
};

const getTransitionName = (item: any) => {
  if (!item?.id) {
    return undefined;
  }
  const href = typeof item?.href === "string" ? item.href : "";
  if (href.startsWith("/events/")) {
    return `event-image-${item.id}`;
  }
  if (
    href.startsWith("/article/") ||
    href.startsWith("/news/") ||
    href.startsWith("/interviews/")
  ) {
    return `main-article-image-${item.id}`;
  }
  return undefined;
};

let primaryParisArticle: any = null;
let secondaryParisArticle: any = null;
let parisFeed: any[] = [];
let hotContentItems: any[] = [];

try {
  const articles = await articlesApi.list();

  const sortedArticles = [...articles].sort(
    (a, b) => getDate(b.createdAt).getTime() - getDate(a.createdAt).getTime(),
  );

  const parisItems = sortedArticles
    .filter(
      (article) =>
        normalizeCategory(article.category) === PARIS_CATEGORY_KEY &&
        !isHotContent(article),
    )
    .map((article) => ({
      ...article,
      href: toArticleHref(article),
    }));

  primaryParisArticle =
    parisItems.find((item) => isMainInCategoryItem(item)) ??
    parisItems[0] ??
    null;

  const parisWithoutPrimary = parisItems.filter((item) =>
    primaryParisArticle ? item.id !== primaryParisArticle.id : true,
  );

  secondaryParisArticle = parisWithoutPrimary[0] ?? null;
  parisFeed = parisWithoutPrimary.slice(1);

  hotContentItems = sortedArticles
    .filter((article) => isHotContent(article))
    .map((article) => ({
      ...article,
      href: toArticleHref(article),
    }))
    .slice(0, 6);
} catch (error) {
  console.error("Failed to fetch paris page articles:", error);
}
---

<Layout
  navbarVariant="default"
  includePreFooterCTA={false}
  title="Париж - Maag"
  useClientRouter={true}
>
  <main class="bg-base-200 min-h-screen pb-16">
    <section class="max-w-[1400px] mx-auto px-4 lg:px-8 pt-8 lg:pt-12">
      <div class="border-b border-base-content/25 pb-6">
        <h1 class="text-4xl lg:text-6xl font-oswald font-thin leading-none">
          Париж
        </h1>
      </div>

      <section
        class="mt-8 lg:mt-10 grid grid-cols-1 lg:grid-cols-[1.55fr_1fr_0.9fr] gap-6 lg:gap-7"
      >
        <div class="lg:pr-4 lg:border-r lg:border-base-content/15">
          {
            primaryParisArticle ? (
              <article>
                <a
                  href={primaryParisArticle.href}
                  class="block overflow-hidden transition-opacity duration-200 hover:opacity-90"
                >
                  <img
                    src={primaryParisArticle.imageUrl || picture1.src}
                    alt={primaryParisArticle.title}
                    class="w-full h-[320px] lg:h-[560px] object-cover object-center"
                    loading="lazy"
                    transition:name={getTransitionName(primaryParisArticle)}
                  />
                </a>
                <a href={primaryParisArticle.href} class="block mt-5">
                  <h2 class="text-3xl lg:text-[52px] leading-[1.02] font-oswald font-thin hover:underline">
                    {primaryParisArticle.title}
                  </h2>
                </a>
                {primaryParisArticle.lead && (
                  <p class="mt-3 text-lg leading-relaxed text-base-content/80">
                    {truncateText(primaryParisArticle.lead, 220)}
                  </p>
                )}
                <p class="mt-4 text-xs font-inter uppercase tracking-[0.22em] text-base-content/55">
                  {formatDate(primaryParisArticle.createdAt)}
                </p>
              </article>
            ) : (
              <article class="border border-base-content/15 p-6">
                <p class="text-base-content/70">
                  Пока нет материалов категории «Париж».
                </p>
              </article>
            )
          }
        </div>

        <div class="lg:pr-4 lg:border-r lg:border-base-content/15">
          {
            secondaryParisArticle ? (
              <article>
                <a
                  href={secondaryParisArticle.href}
                  class="block overflow-hidden transition-opacity duration-200 hover:opacity-90"
                >
                  <img
                    src={secondaryParisArticle.imageUrl || picture1.src}
                    alt={secondaryParisArticle.title}
                    class="w-full h-[320px] lg:h-[420px] object-cover object-center"
                    loading="lazy"
                    transition:name={getTransitionName(secondaryParisArticle)}
                  />
                </a>
                <a href={secondaryParisArticle.href} class="block mt-5">
                  <h3 class="text-3xl lg:text-[46px] leading-[1.05] font-oswald font-thin hover:underline">
                    {secondaryParisArticle.title}
                  </h3>
                </a>
                {secondaryParisArticle.lead && (
                  <p class="mt-3 text-lg leading-relaxed text-base-content/80">
                    {truncateText(secondaryParisArticle.lead, 180)}
                  </p>
                )}
                <p class="mt-4 text-xs font-inter uppercase tracking-[0.22em] text-base-content/55">
                  {formatDate(secondaryParisArticle.createdAt)}
                </p>
              </article>
            ) : (
              <article class="border border-base-content/15 p-6">
                <p class="text-base-content/70">
                  Добавьте еще один материал в Париж для второго блока.
                </p>
              </article>
            )
          }
        </div>

        <aside>
          <h2
            class="text-xs uppercase tracking-[0.35em] text-base-content/60 font-inter mb-4"
          >
            {CATEGORY_LABELS[HOT_CONTENT_CATEGORY_KEY]}
          </h2>

          {
            hotContentItems.length > 0 ? (
              <div class="divide-y divide-base-content/15 border-y border-base-content/20">
                {hotContentItems.map((item) => (
                  <article class="py-4 grid grid-cols-[minmax(0,1fr)_84px] gap-3 items-start">
                    <div>
                      <a href={item.href} class="block">
                        <h4 class="text-3xl lg:text-[40px] leading-[1.02] font-oswald font-thin hover:underline">
                          {item.title}
                        </h4>
                      </a>
                      {item.lead && (
                        <p class="mt-2 text-sm leading-relaxed text-base-content/75">
                          {truncateText(item.lead, 95)}
                        </p>
                      )}
                      <p class="mt-3 text-[11px] font-inter uppercase tracking-[0.18em] text-base-content/50">
                        {formatDate(item.createdAt)}
                      </p>
                    </div>
                    <a
                      href={item.href}
                      class="block overflow-hidden mt-1 transition-opacity duration-200 hover:opacity-90"
                    >
                      <img
                        src={item.imageUrl || picture1.src}
                        alt={item.title}
                        class="w-[84px] h-[84px] object-cover object-center"
                        loading="lazy"
                        transition:name={getTransitionName(item)}
                      />
                    </a>
                  </article>
                ))}
              </div>
            ) : (
              <p class="text-sm text-base-content/70">
                Пока нет материалов в блоке hot content.
              </p>
            )
          }
        </aside>
      </section>

      <section class="mt-10 lg:mt-14 border-t border-base-content/25 pt-8">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-x-7 gap-y-10">
          {
            parisFeed.map((item) => (
              <article class="border-b border-base-content/15 pb-6">
                <a
                  href={item.href}
                  class="block overflow-hidden transition-opacity duration-200 hover:opacity-90"
                >
                  <img
                    src={item.imageUrl || picture1.src}
                    alt={item.title}
                    class="w-full h-[220px] lg:h-[250px] object-cover object-center"
                    loading="lazy"
                    transition:name={getTransitionName(item)}
                  />
                </a>
                <a href={item.href} class="block mt-4">
                  <h3 class="text-3xl lg:text-[40px] leading-[1.04] font-oswald font-thin hover:underline">
                    {item.title}
                  </h3>
                </a>
                {item.lead && (
                  <p class="mt-3 text-base leading-relaxed text-base-content/75">
                    {truncateText(item.lead, 190)}
                  </p>
                )}
                <p class="mt-4 text-xs font-inter uppercase tracking-[0.2em] text-base-content/55">
                  {formatDate(item.createdAt)}
                </p>
              </article>
            ))
          }
        </div>
      </section>
    </section>
  </main>
</Layout>
