---
import Layout from "../../Layouts/Layout.astro";
import ArticleHeader from "../../components/article/ArticleHeader.astro";
import ArticleAuthor from "../../components/article/ArticleAuthor.astro";
import ArticleDate from "@/components/article/ArticleDate.astro";
import { flippersApi } from "../../lib/api/api";
import ArrowLeft from "../../assets/svg/arrowLeft.svg";
import ArrowRight from "../../assets/svg/arrowRight.svg";

const { id } = Astro.params;
const flipper = await flippersApi.getById(id);

if (!flipper) {
  return Astro.redirect("/404");
}
const flipperState = JSON.stringify({
  activeSlide: 0,
  slides: flipper.carouselContent || [],
});
---

<Layout title={flipper.title}>
  <div class="container mx-auto px-4 py-8" x-data={flipperState}>
    <div class="pt-[50px] pb-[70px] flex flex-col items-center gap-[50px]">
      <div class="flex flex-col gap-4 max-w-[825px] w-full">
        <ArticleHeader category={flipper.techTags[0]} title={flipper.title} />
        {
          flipper.author && (
            <ArticleAuthor
              name={`${flipper.author.firstName} ${flipper.author.lastName}`}
              avatarUrl={flipper.author.avatar}
            />
          )
        }
        {flipper.createdAt && <ArticleDate createdAt={flipper.createdAt} />}
      </div>
    </div>

    <div class="relative w-full max-w-[1200px] mx-auto">
      <div class="overflow-hidden relative h-[600px] w-full">
        <template x-for="(item, index) in slides" :key="index">
          <div
            x-show="activeSlide === index"
            class="absolute inset-0 duration-700 ease-in-out"
            x-transition:enter="transition ease-in-out duration-700"
            x-transition:enter-start="opacity-0"
            x-transition:enter-end="opacity-100"
            x-transition:leave="transition ease-in-out duration-700"
            x-transition:leave-start="opacity-100"
            x-transition:leave-end="opacity-0"
          >
            <img
              :src="item.imageUrl"
              class="w-full h-full object-contain rounded-lg"
              :alt="item.caption || 'Carousel image'"
            />
          </div>
        </template>

        <button
          @click="activeSlide = (activeSlide - 1 + slides.length) % slides.length"
          class="absolute top-1/2 left-2 transform -translate-y-1/2 rounded-full p-3 transition cursor-pointer text-neutral-300 hover:text-neutral-400"
        >
          <ArrowLeft />
        </button>
        <button
          @click="activeSlide = (activeSlide + 1) % slides.length"
          class="absolute top-1/2 right-2 transform -translate-y-1/2 rounded-full p-3 transition cursor-pointer text-neutral-300 hover:text-neutral-400"
        >
          <ArrowRight />
        </button>
      </div>

      <!-- Caption and dots moved here -->
      <div class="mt-4 text-center">
        <p
          class="text-base-content font-oswald font-thin text-lg"
          x-text="slides[activeSlide].caption"
        >
        </p>
      </div>
      <hr class="my-4 border-base-300" />
      <div class="flex justify-center space-x-2 mt-2 mb-16">
        <template x-for="(slide, index) in slides" :key="index">
          <button
            @click="activeSlide = index"
            :class="{'bg-primary': activeSlide === index, 'bg-base-300': activeSlide !== index}"
            class="w-3 h-3 rounded-full hover:bg-primary transition cursor-pointer"
          ></button>
        </template>
      </div>
    </div>
  </div>
</Layout>
