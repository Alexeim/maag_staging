---
import Layout from "../Layouts/Layout.astro";
---

<Layout
  navbarVariant="default"
  includePreFooterCTA={false}
  title="Личный кабинет - Maag"
  useClientRouter={true}
>
  <div class="min-h-screen bg-base-200 py-8">
    <div class="max-w-4xl mx-auto px-4 lg:px-8">
      <!-- Page Header -->
      <div class="mb-8">
        <h1
          class="text-4xl font-lora font-normal uppercase tracking-[0.46em] text-base-content mb-5"
        >
          Личный кабинет
        </h1>

        <!-- Navigation Tabs -->
        <div class="flex flex-col lg:flex-row gap-4 lg:gap-8">
          <button
            class="w-full lg:w-auto text-left lg:text-center text-xs font-inter font-semibold uppercase tracking-[0.25em] text-base-content border-b-2 border-accent pb-1"
            x-data="{ active: true }"
            :class="{ 'text-accent': active }"
          >
            настройка аккаунта
          </button>
          <button
            class="w-full lg:w-auto text-left lg:text-center text-xs font-inter font-normal uppercase tracking-[0.25em] text-base-content/70 hover:text-base-content transition-colors"
            x-data="{ active: false }"
            :class="{ 'text-accent': active }"
          >
            закладки
          </button>
        </div>
      </div>

      <!-- Main Content -->
      <div class="space-y-20">
        <!-- Subscription Section -->
        <div class="space-y-8" x-data="$lazy('subscriptionManager')">
          <!-- Section Header -->
          <div class="space-y-6">
            <div class="w-full h-px bg-neutral-200"></div>
            <h2
              class="text-base font-lora font-normal uppercase tracking-[0.46em] text-base-content"
            >
              Подписка
            </h2>
          </div>

          <!-- Subscription Content -->
          <div class="space-y-8 w-full max-w-2xl">
            <template x-if="!$store.auth.isProfileLoaded">
              <p>Загрузка данных о подписке...</p>
            </template>

            <template x-if="$store.auth.isProfileLoaded">
              <div>
                <!-- Если подписка активна -->
                <template x-if="isSubscribed">
                  <div class="space-y-4">
                    <p>Статус: <span class="font-bold text-accent" x-text="subscriptionStatus"></span></p>
                    <p>Оплачено до: <span class="font-bold" x-text="subscriptionEndDate"></span></p>
                    <button @click="manageSubscription()" class="btn btn-primary w-full lg:w-auto">
                      Управлять подпиской
                    </button>
                  </div>
                </template>

                <!-- Если подписки нет -->
                <template x-if="!isSubscribed">
                  <div class="space-y-4">
                    <p>У вас нет активной подписки.</p>
                    <button @click="createSubscription()" class="btn btn-primary w-full lg:w-auto">
                      Подписаться
                    </button>
                    <button @click="forceRefresh()" class="btn btn-secondary w-full lg:w-auto">
                      Обновить статус
                    </button>
                  </div>
                </template>
              </div>
            </template>
          </div>
        </div>

        <!-- Account Data Section -->
        <div class="space-y-8">
          <!-- Section Header -->
          <div class="space-y-6">
            <div class="w-full h-px bg-neutral-200"></div>
            <h2
              class="text-base font-lora font-normal uppercase tracking-[0.46em] text-base-content"
            >
              Данные аккаунта
            </h2>
          </div>

          <!-- Account Form -->
          <div class="space-y-10 w-full max-w-lg" x-data="$lazy('profile')">
            <!-- Show loading states -->
            <template x-if="$store.auth.isLoading">
              <p>Проверка сессии...</p>
            </template>
            <template x-if="!$store.auth.isLoading && !$store.auth.isLoggedIn">
              <p>Пожалуйста, войдите, чтобы увидеть свой профиль.</p>
            </template>
            <template x-if="!$store.auth.isLoading && $store.auth.isLoggedIn && !$store.auth.isProfileLoaded">
              <p>Загрузка данных профиля...</p>
            </template>

            <!-- Show form only when logged in AND profile is loaded -->
            <template x-if="$store.auth.isProfileLoaded">
              <div>
                <!-- Email Field (Read-only) -->
                <div class="space-y-4 mb-10">
                  <label class="text-xs font-inter font-normal uppercase tracking-[0.25em] text-base-content">email</label>
                  <div class="bg-base-100 border border-neutral-200 rounded-lg p-2">
                    <div x-text="$store.auth.user?.email" class="w-full bg-transparent text-xs font-inter text-neutral-400 outline-none"></div>
                  </div>
                </div>

                <!-- Password Field -->
                <div class="space-y-4 mb-10">
                  <label class="text-xs font-inter font-normal uppercase tracking-[0.25em] text-base-content">Пароль</label>
                  <div class="flex flex-col lg:flex-row lg:items-center gap-4 lg:gap-2">
                    <div class="bg-base-100 border border-neutral-200 rounded-lg p-2 w-full lg:flex-1">
                      <input type="password" value="**********" readonly class="w-full bg-transparent text-[16px] lg:text-xs font-inter text-neutral-400 outline-none" />
                    </div>
                    <div class="w-full lg:w-auto">
                      <button class="btn btn-primary w-full lg:w-auto">Поменять пароль</button>
                    </div>
                  </div>
                </div>

                <!-- Name Fields -->
                <div class="space-y-4 mb-4">
                  <label class="text-xs font-inter font-normal uppercase tracking-[0.25em] text-base-content">First Name</label>
                  <div class="bg-base-100 border border-neutral-200 rounded-lg p-2">
                    <input type="text" x-model="form.firstName" class="w-full bg-transparent text-[16px] lg:text-xs font-inter text-neutral-400 outline-none" />
                  </div>
                </div>
                <div class="space-y-4">
                  <label class="text-xs font-inter font-normal uppercase tracking-[0.25em] text-base-content">Last Name</label>
                  <div class="bg-base-100 border border-neutral-200 rounded-lg p-2">
                    <input type="text" x-model="form.lastName" class="w-full bg-transparent text-[16px] lg:text-xs font-inter text-neutral-400 outline-none" />
                  </div>
                </div>

                <!-- Action Buttons -->
                <div class="space-y-4 mt-10">
                  <button @click="saveChanges()" class="w-full bg-primary text-primary-content rounded-2xl py-2 px-4 text-sm font-inter font-normal hover:bg-primary/90 transition-colors">
                    Сохранить изменения
                  </button>
                  <button @click="deleteAccount()" class="w-full border border-error text-error rounded-2xl py-2 px-4 text-sm font-inter font-normal hover:bg-error/5 transition-colors">
                    Удалить аккаунт
                  </button>
                </div>
              </div>
            </template>
          </div>
        </div>
      </div>
    </div>
  </div>
</Layout>
