---
import Button from "@/components/common/Button.astro";
import { CloudUpload } from "lucide-astro";

interface Props {
  heading: string;
  submitLabel: string;
  newsCreatorState: string;
  cancelHref?: string;
  deleteArticleId?: string | null;
  deleteRedirect?: string;
}

const {
  heading,
  submitLabel,
  newsCreatorState,
  cancelHref,
  deleteArticleId,
  deleteRedirect = "/dashboard/news",
} = Astro.props as Props;
---

<div
  class="max-w-4xl mx-auto"
  x-data={`$lazy('newsCreator', ${newsCreatorState})`}
>
  <h1 class="text-3xl font-bold mb-6">{heading}</h1>

  <!-- Main info section -->
  <section
    class="mb-6 p-6 bg-base-100 border border-base-300 rounded-xl shadow-sm"
  >
    <h2 class="text-xl font-semibold mb-4">Основная информация</h2>

    <label class="block text-sm font-medium text-base-content mb-2"
      >Заголовок новости</label
    >
    <template x-if="isEditingTitle">
      <div>
        <input
          type="text"
          x-model="editingTitleText"
          class="bg-base-100 border border-base-300 text-base-content text-sm rounded-lg focus:ring-primary focus:border-primary block w-full p-2.5"
        />
        <div class="flex justify-end gap-3 mt-3">
          <Button variant="secondary" size="sm" @click="cancelEditTitle()"
            >Отмена</Button
          >
          <Button variant="primary" size="sm" @click="saveTitle()"
            >Сохранить</Button
          >
        </div>
      </div>
    </template>
    <template x-if="!isEditingTitle">
      <div
        class="flex justify-between items-center border border-base-300 rounded-lg px-4 py-3"
      >
        <h3
          class="text-lg font-semibold"
          x-text="article.title || 'Введите заголовок...'"
        >
        </h3>
        <Button variant="outline" size="sm" @click="editTitle()"
          >Редактировать</Button
        >
      </div>
    </template>

    <div class="mt-4">
      <label class="block text-sm font-medium text-base-content mb-2"
        >Главный абзац (лид)</label
      >
      <textarea
        x-model="article.lead"
        rows="4"
        class="bg-base-100 border border-base-300 text-base-content text-sm rounded-lg focus:ring-primary focus:border-primary block w-full p-2.5"
        placeholder="Текст, который отображается рядом с картинкой в шапке новости..."
      ></textarea>
    </div>

    <hr class="my-6" />

    <label
      for="news-category-select"
      class="block text-sm font-medium text-base-content mb-2">Категория</label
    >
    <select
      id="news-category-select"
      x-model="article.category"
      @change="handleCategoryChange($event.target.value)"
      class="bg-base-100 border border-base-300 text-base-content text-sm rounded-lg focus:ring-primary focus:border-primary block w-full p-2.5 cursor-pointer"
    >
      <option value="" disabled>Выберите категорию...</option>
      <option value="culture">Культура</option>
      <option value="paris">Париж</option>
    </select>

    <div class="mt-4 flex items-center gap-3">
      <input
        id="news-hot-content-flag"
        type="checkbox"
        x-model="article.isHotContent"
        class="w-4 h-4 text-primary bg-base-200 border-base-300 rounded-sm focus:ring-primary focus:ring-2 cursor-pointer"
      />
      <label
        for="news-hot-content-flag"
        class="text-sm font-medium text-base-content cursor-pointer"
      >
        Отметить как «Самое читаемое»
      </label>
    </div>


    <div class="mt-4 flex items-center gap-3">
      <input
        id="news-main-in-category-flag"
        type="checkbox"
        x-model="article.isMainInCategory"
        class="w-4 h-4 text-primary bg-base-200 border-base-300 rounded-sm focus:ring-primary focus:ring-2 cursor-pointer"
      />
      <label
        for="news-main-in-category-flag"
        class="text-sm font-medium text-base-content cursor-pointer"
      >
        Главная новость в категории
      </label>
    </div>

    <!-- Tags -->
    <div class="mt-6">
      <label class="block text-sm font-medium text-base-content mb-3"
        >Теги</label
      >

      <template x-if="getAvailableTags().length > 0">
        <div class="flex flex-wrap gap-2">
          <template x-for="tag in getAvailableTags()" :key="tag.value">
            <button
              type="button"
              class="px-4 py-2 rounded-full border text-sm transition cursor-pointer"
              :class="isTagSelected(tag.value) ? 'bg-primary text-primary-content border-primary' : 'bg-base-100 text-base-content border-base-300 hover:bg-base-200'"
              @click="toggleTag(tag.value)"
            >
              <span x-text="tag.title"></span>
            </button>
          </template>
        </div>
      </template>

      <template x-if="getAvailableTags().length === 0">
        <p class="text-sm text-base-content/70">
          Для выбранной категории пока нет готовых тегов — добавь свои.
        </p>
      </template>

      <div class="mt-4 flex flex-col gap-2">
        <div class="flex flex-col sm:flex-row gap-2">
          <input
            type="text"
            x-model="newTagInput"
            class="bg-base-100 border border-base-300 text-base-content text-sm rounded-lg focus:ring-primary focus:border-primary block w-full p-2.5"
            placeholder="Добавь тег латиницей"
          />
          <Button
            variant="outline"
            size="sm"
            type="button"
            @click="addCustomTag()">Добавить тег</Button
          >
        </div>
      </div>

      <div class="mt-3 flex flex-col gap-3">
        <template x-if="article.tags.length > 0">
          <div>
            <p class="text-xs uppercase tracking-[0.2em] text-base-content/60">
              Категорийные теги
            </p>
            <div class="flex flex-wrap gap-2 mt-1">
              <template x-for="tag in article.tags" :key="tag">
                <span
                  class="inline-flex items-center gap-2 px-3 py-1 bg-base-200 rounded-full text-sm"
                >
                  <span x-text="getTagLabel(tag)"></span>
                  <button
                    type="button"
                    class="text-base-content/60 hover:text-base-content cursor-pointer"
                    @click="removeTag(tag)"
                  >
                    &times;
                  </button>
                </span>
              </template>
            </div>
          </div>
        </template>

        <template x-if="article.techTags.length > 0">
          <div>
            <p class="text-xs uppercase tracking-[0.2em] text-base-content/60">
              Техтеги
            </p>
            <div class="flex flex-wrap gap-2 mt-1">
              <template x-for="tag in article.techTags" :key="`tech-${tag}`">
                <span
                  class="inline-flex items-center gap-2 px-3 py-1 bg-base-200 rounded-full text-sm"
                >
                  <span x-text="tag"></span>
                  <button
                    type="button"
                    class="text-base-content/60 hover:text-base-content cursor-pointer"
                    @click="removeTechTag(tag)"
                  >
                    &times;
                  </button>
                </span>
              </template>
            </div>
          </div>
        </template>
      </div>
    </div>

    <hr class="my-6" />

    <!-- Cover image upload -->
    <label class="block text-sm font-medium text-base-content mb-2"
      >Обложка новости</label
    >
    <div class="flex items-center" x-data="{ fileName: '' }">
      <label
        for="news-file-upload"
        class="cursor-pointer text-white bg-green-700 hover:bg-green-800 focus:ring-green-300 rounded-2xl flex flex-row gap-2 items-center justify-center py-2 px-4"
      >
        <CloudUpload />
        Загрузить файл
      </label>
      <input
        id="news-file-upload"
        type="file"
        class="hidden"
        @change="handleImageUpload($event); fileName = $event.target.files[0]?.name || ''"
        accept="image/png, image/jpeg, image/webp"
      />
      <span
        x-text="fileName ? fileName : (article.imageUrl ? 'Изображение загружено' : 'Файл не выбран')"
        class="ml-4 text-sm text-base-content/70"></span>
    </div>
    <div x-show="uploading" class="mt-4">
      <p>Загрузка: <span x-text="uploadProgress.toFixed(2) + '%'"></span></p>
      <div class="w-full bg-base-200 rounded-full h-2">
        <div
          class="bg-primary h-2 rounded-full"
          :style="{ width: uploadProgress + '%' }"
        >
        </div>
      </div>
    </div>
    <div x-show="article.imageUrl && !uploading" class="mt-4 space-y-4">
      <p class="text-sm text-success">Обложка загружена!</p>
      <img
        :src="article.imageUrl"
        alt="Предпросмотр обложки"
        class="rounded-md max-h-60 w-full object-cover"
      />
      <div>
        <label class="block text-sm font-medium text-base-content mb-2"
          >Подпись к изображению</label
        >
        <template x-if="isEditingCaption">
          <div>
            <input
              type="text"
              x-model="editingCaptionText"
              class="bg-base-100 border border-base-300 text-base-content text-sm rounded-lg focus:ring-primary focus:border-primary block w-full p-2.5"
              placeholder="Введите подпись..."
            />
            <div class="flex justify-end gap-3 mt-3">
              <Button variant="secondary" size="sm" @click="cancelEditCaption()"
                >Отмена</Button
              >
              <Button variant="primary" size="sm" @click="saveCaption()"
                >Сохранить</Button
              >
            </div>
          </div>
        </template>
        <template x-if="!isEditingCaption">
          <div
            class="flex justify-between items-center border border-base-300 rounded-lg px-4 py-3"
          >
            <p
              class="text-base-content"
              x-text="article.imageCaption || 'Подпись отсутствует...'"
            >
            </p>
            <Button variant="outline" size="sm" @click="editCaption()"
              >Редактировать</Button
            >
          </div>
        </template>
      </div>
    </div>
  </section>

  <!-- Content blocks (paragraph only) -->
  <section class="p-6 bg-base-100 border border-base-300 rounded-xl shadow-sm">
    <h2 class="text-xl font-semibold mb-4">Содержание новости</h2>
    <div class="space-y-4">
      <template x-for="(block, index) in article.contentBlocks" :key="index">
        <div
          class="p-4 border border-base-300 rounded-lg bg-base-100 relative group"
        >
          <template x-if="editingIndex === index">
            <div class="space-y-4">
              <h3 class="text-lg font-semibold">Абзац</h3>
              <textarea
                x-model="editingBlock.text"
                class="bg-base-100 border border-base-300 text-base-content text-sm rounded-lg focus:ring-primary focus:border-primary block w-full p-2.5"
                rows="5"></textarea>
              <div class="flex justify-end gap-3">
                <Button variant="secondary" @click="cancelEdit()">Отмена</Button>
                <Button variant="primary" @click="updateBlock()"
                  >Сохранить блок</Button
                >
              </div>
            </div>
          </template>

          <template x-if="editingIndex !== index">
            <div class="space-y-3">
              <p class="text-base" x-text="block.text"></p>
              <div
                class="absolute top-3 right-3 opacity-0 group-hover:opacity-100 transition-opacity flex gap-2"
              >
                <Button variant="outline" size="sm" @click="editBlock(index)"
                  >Редактировать</Button
                >
                <Button variant="error" size="sm" @click="deleteBlock(index)"
                  >Удалить</Button
                >
              </div>
            </div>
          </template>
        </div>
      </template>
    </div>

    <div class="mt-6 text-center">
      <Button variant="primary" @click="openBlockSelector()"
        >+ Добавить абзац</Button
      >
    </div>
  </section>

  <!-- Actions -->
  <div
    class="mt-8 flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between"
  >
    <div class="flex gap-2">
      <template x-if="isEditMode && articleId">
        <button
          type="button"
          class="cursor-pointer text-white bg-red-700 hover:bg-red-800 focus:ring-red-300 flex flex-row items-center justify-center px-4 py-2 rounded-lg"
          @click="deleteArticle(deleteRedirect)"
        >
          Удалить новость
        </button>
      </template>
    </div>
    <div class="flex justify-end gap-3">
      {
        cancelHref && (
          <a
            href={cancelHref}
            class="cursor-pointer text-white bg-yellow-400 hover:bg-yellow-500 focus:ring-yellow-300 flex flex-row items-center justify-center px-4 py-2 rounded-lg"
          >
            Отмена
          </a>
        )
      }
      <Button variant="primary" @click="saveArticle()">{submitLabel}</Button>
    </div>
  </div>
</div>
