---
import Button from "@/components/common/Button.astro";

import { CloudUpload } from "lucide-astro";

interface Props {
  heading: string;
  submitLabel: string;
  eventCreatorState: string;
  cancelHref?: string;
  deleteEventId?: string | null;
  deleteRedirect?: string;
}

const {
  heading,
  submitLabel,
  eventCreatorState,
  cancelHref,
  deleteEventId = null,
  deleteRedirect = "/dashboard/events",
} = Astro.props as Props;
---

<div class="max-w-4xl mx-auto" x-data={`$lazy('eventCreator', ${eventCreatorState})`}>
  <h1 class="text-3xl font-bold mb-6">{heading}</h1>

  <section class="mb-6 p-6 bg-base-100 border border-base-300 rounded-xl shadow-sm">
    <h2 class="text-xl font-semibold mb-4">Основная информация</h2>

    <label class="block text-sm font-medium text-base-content mb-2">Заголовок события</label>
    <template x-if="isEditingTitle">
      <div>
        <input
          type="text"
          x-model="editingTitleText"
          class="bg-base-100 border border-base-300 text-base-content text-sm rounded-lg focus:ring-primary focus:border-primary block w-full p-2.5"
        />
        <div class="flex justify-end gap-3 mt-3">
          <Button variant="secondary" size="sm" @click="cancelEditTitle()">Отмена</Button>
          <Button variant="primary" size="sm" @click="saveTitle()">Сохранить</Button>
        </div>
      </div>
    </template>
    <template x-if="!isEditingTitle">
      <div class="flex justify-between items-center border border-base-300 rounded-lg px-4 py-3">
        <h3 class="text-lg font-semibold" x-text="article.title || 'Введите заголовок...'"></h3>
        <Button variant="outline" size="sm" @click="editTitle()">Редактировать</Button>
      </div>
    </template>

    <div class="mt-4">
      <label class="block text-sm font-medium text-base-content mb-2">Вводка (лид)</label>
      <textarea
        x-model="article.lead"
        rows="3"
        class="bg-base-100 border border-base-300 text-base-content text-sm rounded-lg focus:ring-primary focus:border-primary block w-full p-2.5"
        placeholder="Краткое описание события, которое отображается под заголовком..."
      ></textarea>
    </div>

    <div class="mt-6 space-y-3">
      <label class="block text-sm font-medium text-base-content">Автор</label>

      <div class="flex flex-wrap gap-2">
        <button
          type="button"
          @click="useNewAuthor = false"
          class="px-3 py-2 border text-sm cursor-pointer"
          :class="!useNewAuthor ? 'bg-primary text-primary-content border-primary' : 'bg-base-100 border-base-300 text-base-content'"
        >
          Выбрать из списка
        </button>
        <button
          type="button"
          @click="useNewAuthor = true"
          class="px-3 py-2 border text-sm cursor-pointer"
          :class="useNewAuthor ? 'bg-primary text-primary-content border-primary' : 'bg-base-100 border-base-300 text-base-content'"
        >
          Новый автор
        </button>
      </div>

      <div x-show="!useNewAuthor">
        <select
          x-model="selectedAuthorId"
          class="bg-base-100 border border-base-300 text-base-content text-sm focus:ring-primary focus:border-primary block w-full p-2.5 cursor-pointer"
        >
          <option value="">Выберите автора...</option>
          <template x-for="author in authors" :key="author.id">
            <option :value="author.id" x-text="getAuthorLabel(author)"></option>
          </template>
        </select>
        <p x-show="authorsLoading" class="text-xs text-base-content/60 mt-1">Загружаем авторов...</p>
      </div>

      <div x-show="useNewAuthor" class="grid grid-cols-1 sm:grid-cols-2 gap-3">
        <input
          type="text"
          x-model="newAuthorFirstName"
          class="bg-base-100 border border-base-300 text-base-content text-sm focus:ring-primary focus:border-primary block w-full p-2.5"
          placeholder="Имя автора"
        />
        <input
          type="text"
          x-model="newAuthorLastName"
          class="bg-base-100 border border-base-300 text-base-content text-sm focus:ring-primary focus:border-primary block w-full p-2.5"
          placeholder="Фамилия автора"
        />
      </div>
    </div>

    <hr class="my-6" />

    <label class="block text-sm font-medium text-base-content mb-2">Категория</label>
    <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
      <template x-for="(label, value) in categoryLabels" :key="value">
        <button
          type="button"
          class="px-4 py-2 rounded-lg border text-sm transition cursor-pointer"
          :class="eventForm.category === value ? 'bg-primary text-primary-content border-primary' : 'bg-base-100 text-base-content border-base-300 hover:bg-base-200'"
          @click="setCategory(value)"
        >
          <span x-text="label"></span>
        </button>
      </template>
    </div>

    <div class="mt-4 flex items-center gap-3">
      <input
        id="landing-flag"
        type="checkbox"
        x-model="eventForm.isOnLanding"
        class="w-4 h-4 text-primary bg-base-200 border-base-300 rounded-sm focus:ring-primary focus:ring-2 cursor-pointer"
      />
      <label for="landing-flag" class="text-sm font-medium text-base-content cursor-pointer">
        Показать событие в блоке «Календарь» на главной
      </label>
    </div>

    <div class="mt-4 flex items-center gap-3">
      <input
        id="main-event-flag"
        type="checkbox"
        x-model="eventForm.isMainEvent"
        class="w-4 h-4 text-primary bg-base-200 border-base-300 rounded-sm focus:ring-primary focus:ring-2 cursor-pointer"
      />
      <label for="main-event-flag" class="text-sm font-medium text-base-content cursor-pointer">
        Отметить как «Событие месяца» в календаре
      </label>
    </div>

    <div class="mt-6">
      <label class="block text-sm font-medium text-base-content mb-2">Формат дат</label>
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
        <button
          type="button"
          class="px-4 py-2 rounded-lg border text-sm transition cursor-pointer"
          :class="eventForm.dateType === 'single' ? 'bg-primary text-primary-content border-primary' : 'bg-base-100 text-base-content border-base-300 hover:bg-base-200'"
          @click="setDateType('single')"
        >
          Одна дата
        </button>
        <button
          type="button"
          class="px-4 py-2 rounded-lg border text-sm transition cursor-pointer"
          :class="eventForm.dateType === 'duration' ? 'bg-primary text-primary-content border-primary' : 'bg-base-100 text-base-content border-base-300 hover:bg-base-200'"
          @click="setDateType('duration')"
        >
          Диапазон дат
        </button>
      </div>
    </div>

    <div class="mt-6 grid grid-cols-1 gap-4 sm:grid-cols-2">
      <div>
        <label class="block text-sm font-medium text-base-content mb-2">Дата начала</label>
        <input
          type="date"
          x-model="eventForm.startDate"
          @change="setStartDate($event.target.value)"
          class="bg-base-100 border border-base-300 text-base-content text-sm rounded-lg focus:ring-primary focus:border-primary block w-full p-2.5 cursor-pointer"
        />
      </div>
      <div x-show="eventForm.dateType === 'duration'">
        <label class="block text-sm font-medium text-base-content mb-2">Дата окончания</label>
        <input
          type="date"
          x-model="eventForm.endDate"
          @change="setEndDate($event.target.value)"
          class="bg-base-100 border border-base-300 text-base-content text-sm rounded-lg focus:ring-primary focus:border-primary block w-full p-2.5 cursor-pointer"
          placeholder="Оставь пустым, если событие на один день"
        />
      </div>
    </div>

    <div class="mt-6">
      <label class="block text-sm font-medium text-base-content mb-2">Адрес / место</label>
      <textarea
        x-model="eventForm.address"
        rows="3"
        class="bg-base-100 border border-base-300 text-base-content text-sm rounded-lg focus:ring-primary focus:border-primary block w-full p-2.5"
        placeholder="Например: Paris, Grand Palais, Avenue Winston Churchill, 75008"
      ></textarea>
    </div>

    <div class="mt-6">
      <label class="block text-sm font-medium text-base-content mb-2">Время события</label>
      <select
        x-model="eventForm.timeMode"
        @change="setTimeMode($event.target.value)"
        class="bg-base-100 border border-base-300 text-base-content text-sm rounded-lg focus:ring-primary focus:border-primary block w-full p-2.5 cursor-pointer"
      >
        <option value="none">Не указывать время</option>
        <option value="start">Только время начала</option>
        <option value="range">Диапазон времени</option>
      </select>

      <div class="mt-4 grid grid-cols-1 sm:grid-cols-2 gap-4" x-show="eventForm.timeMode !== 'none'">
        <div>
          <label class="block text-sm font-medium text-base-content mb-2">Начало</label>
          <input
            type="time"
            x-model="eventForm.startTime"
            class="bg-base-100 border border-base-300 text-base-content text-sm rounded-lg focus:ring-primary focus:border-primary block w-full p-2.5"
          />
        </div>
        <div x-show="eventForm.timeMode === 'range'">
          <label class="block text-sm font-medium text-base-content mb-2">Окончание</label>
          <input
            type="time"
            x-model="eventForm.endTime"
            class="bg-base-100 border border-base-300 text-base-content text-sm rounded-lg focus:ring-primary focus:border-primary block w-full p-2.5"
          />
        </div>
      </div>
    </div>

    <div class="mt-6">
      <label class="block text-sm font-medium text-base-content mb-3">Теги</label>

      <template x-if="getAvailableTags().length > 0">
        <div class="flex flex-wrap gap-2">
          <template x-for="tag in getAvailableTags()" :key="tag.value">
            <button
              type="button"
              class="px-4 py-2 rounded-full border text-sm transition cursor-pointer"
              :class="isTagSelected(tag.value) ? 'bg-primary text-primary-content border-primary' : 'bg-base-100 text-base-content border-base-300 hover:bg-base-200'"
              @click="toggleTag(tag.value)"
            >
              <span x-text="tag.title"></span>
            </button>
          </template>
        </div>
      </template>

      <template x-if="getAvailableTags().length === 0">
        <p class="text-sm text-base-content/70">
          Выбери категорию, тогда покажем готовые теги.
        </p>
      </template>

      <div class="mt-4 flex flex-col gap-2">
        <div class="flex flex-col sm:flex-row gap-2">
          <input
            type="text"
            x-model="newTagInput"
            class="bg-base-100 border border-base-300 text-base-content text-sm rounded-lg focus:ring-primary focus:border-primary block w-full p-2.5"
            placeholder="Добавь тег латиницей, например photo-week"
          />
          <Button variant="outline" size="sm" type="button" @click="addCustomTag()">Добавить тег</Button>
        </div>
        <p class="text-xs text-base-content/60">
          Сохраняем в базу как техтег латиницей, иначе потом не поймём.
        </p>
      </div>

      <div class="mt-3 flex flex-col gap-3">
        <template x-if="article.tags.length > 0">
          <div>
            <p class="text-xs uppercase tracking-[0.2em] text-base-content/60">Категорийные теги</p>
            <div class="flex flex-wrap gap-2 mt-1">
              <template x-for="tag in article.tags" :key="tag">
                <span class="inline-flex items-center gap-2 px-3 py-1 bg-base-200 rounded-full text-sm">
                  <span x-text="getTagLabel(tag)"></span>
                  <button
                    type="button"
                    class="text-base-content/60 hover:text-base-content cursor-pointer"
                    @click="removeTag(tag)"
                  >
                    ×
                  </button>
                </span>
              </template>
            </div>
          </div>
        </template>

        <template x-if="article.techTags.length > 0">
          <div>
            <p class="text-xs uppercase tracking-[0.2em] text-base-content/60">Техтеги</p>
            <div class="flex flex-wrap gap-2 mt-1">
              <template x-for="tag in article.techTags" :key="`tech-${tag}`">
                <span class="inline-flex items-center gap-2 px-3 py-1 bg-base-200 rounded-full text-sm">
                  <span x-text="tag"></span>
                  <button
                    type="button"
                    class="text-base-content/60 hover:text-base-content"
                    @click="removeTechTag(tag)"
                  >
                    ×
                  </button>
                </span>
              </template>
            </div>
          </div>
        </template>
      </div>
    </div>

    <hr class="my-6" />

    <label class="block text-sm font-medium text-base-content mb-2">Обложка события</label>
    <div class="flex items-center" x-data="{ fileName: '' }">
      <label for="file-upload" class="cursor-pointer text-white bg-green-700 hover:bg-green-800 focus:ring-green-300 rounded-2xl flex flex-row gap-2 items-center justify-center py-2 px-4">
      <CloudUpload/>
        Загрузить файл
      </label>
      <input
        id="file-upload"
        type="file"
        class="hidden"
        @change="handleImageUpload($event, true, null); fileName = $event.target.files[0]?.name || ''"
        accept="image/png, image/jpeg, image/webp"
      />
      <span
        x-text="fileName ? fileName : (article.imageUrl ? 'Изображение загружено' : 'Файл не выбран')"
        class="ml-4 text-sm text-base-content/70"
      ></span>
    </div>
    <div x-show="uploading" class="mt-4">
      <p>Загрузка: <span x-text="uploadProgress.toFixed(2) + '%'"></span></p>
      <div class="w-full bg-base-200 rounded-full h-2">
        <div class="bg-primary h-2 rounded-full" :style="{ width: uploadProgress + '%' }"></div>
      </div>
    </div>
    <div x-show="article.imageUrl && !uploading" class="mt-4 space-y-4">
      <p class="text-sm text-success">Главная фотка на месте, можно продолжать.</p>
      <img :src="article.imageUrl" alt="Предпросмотр обложки" class="rounded-md max-h-60 w-full object-cover" />
      <div>
        <label class="block text-sm font-medium text-base-content mb-2">Подпись к изображению</label>
        <template x-if="isEditingCaption">
          <div>
            <input
              type="text"
              x-model="editingCaptionText"
              class="bg-base-100 border border-base-300 text-base-content text-sm rounded-lg focus:ring-primary focus:border-primary block w-full p-2.5"
              placeholder="Введите подпись..."
            />
            <div class="flex justify-end gap-3 mt-3">
              <Button variant="secondary" size="sm" @click="cancelEditCaption()">Отмена</Button>
              <Button variant="primary" size="sm" @click="saveCaption()">Сохранить</Button>
            </div>
          </div>
        </template>
        <template x-if="!isEditingCaption">
          <div class="flex justify-between items-center border border-base-300 rounded-lg px-4 py-3">
            <p class="text-base-content" x-text="article.imageCaption || 'Подпись отсутствует...'"></p>
            <Button variant="outline" size="sm" @click="editCaption()">Редактировать</Button>
          </div>
        </template>
      </div>
    </div>
  </section>

  <section class="p-6 bg-base-100 border border-base-300 rounded-xl shadow-sm">
    <h2 class="text-xl font-semibold mb-4">Контент события</h2>
    <div class="space-y-4">
      <template x-for="(block, index) in article.contentBlocks" :key="index">
        <div class="p-4 border border-base-300 rounded-lg bg-base-100 relative group">
          <template x-if="editingIndex === index">
            <div class="space-y-4">
              <h3 class="text-lg font-semibold capitalize" x-text="editingBlock.type.replace('-', ' ')"></h3>

              <template x-if="['paragraph', 'first-paragraph', 'h1', 'h2', 'h3', 'quote'].includes(editingBlock.type)">
                <textarea x-model="editingBlock.text" class="bg-base-100 border border-base-300 text-base-content text-sm rounded-lg focus:ring-primary focus:border-primary block w-full p-2.5" rows="5"></textarea>
              </template>

              <template x-if="editingBlock.type === 'image'">
                <div x-data="{ blockFileName: '' }" class="space-y-3">
                  <label class="block text-sm font-medium">Изображение</label>
                  <div class="flex items-center gap-3">
                    <label :for="'block-image-upload-' + index" class="cursor-pointer text-white bg-green-700 hover:bg-green-800 focus:ring-green-300 rounded-2xl flex flex-row gap-2 items-center justify-center py-2 px-4">
                      <CloudUpload/>
                      Загрузить файл
                    </label>
                    <input
                      :id="'block-image-upload-' + index"
                      type="file"
                      class="hidden"
                      @change="handleImageUpload($event, false, index); blockFileName = $event.target.files[0]?.name || ''"
                      accept="image/png, image/jpeg, image/webp"
                    />
                    <span
                      x-text="blockFileName || (editingBlock.url ? 'Изображение загружено' : 'Файл не выбран')"
                      class="text-sm text-base-content/70"
                    ></span>
                  </div>
                  <div x-show="uploading && editingIndex === index">
                    <p>Загрузка: <span x-text="uploadProgress.toFixed(2) + '%'"></span></p>
                    <div class="w-full bg-base-200 rounded-full h-2">
                      <div class="bg-primary h-2 rounded-full" :style="{ width: uploadProgress + '%' }"></div>
                    </div>
                  </div>
                  <img x-show="editingBlock.url && !uploading" :src="editingBlock.url" alt="Предпросмотр блока" class="rounded-md max-h-48" />
                  <label class="block text-sm font-medium mt-2">Подпись к изображению</label>
                  <input
                    type="text"
                    x-model="editingBlock.caption"
                    class="bg-base-100 border border-base-300 text-base-content text-sm rounded-lg focus:ring-primary focus:border-primary block w-full p-2.5"
                    placeholder="Введите подпись..."
                  />
                </div>
              </template>

              <template x-if="editingBlock.type === 'two-columns'">
                <div class="space-y-4">
                  <div class="flex gap-4">
                    <div
                      class="w-1/2 space-y-3 p-3 border border-base-300 rounded-lg"
                    >
                      <h4 class="text-md font-semibold">Левая колонка</h4>
                      <label class="block text-sm font-medium"
                        >Тип контента</label
                      >
                      <select
                        x-model="editingBlock.left.type"
                        class="bg-base-100 border border-base-300 text-base-content text-sm rounded-lg focus:ring-primary focus:border-primary block w-full p-2.5"
                      >
                        <option value="text">Текст</option>
                        <option value="image">Изображение</option>
                      </select>

                      <template x-if="editingBlock.left.type === 'text'">
                        <div>
                          <label class="block text-sm font-medium">Текст</label>
                          <textarea
                            x-model="editingBlock.left.content"
                            class="bg-base-100 border border-base-300 text-base-content text-sm rounded-lg focus:ring-primary focus:border-primary block w-full p-2.5"
                            rows="5"></textarea>
                        </div>
                      </template>

                      <template x-if="editingBlock.left.type === 'image'">
                        <div
                          x-data="{ leftBlockFileName: '' }"
                          class="space-y-3"
                        >
                          <label class="block text-sm font-medium"
                            >Изображение</label
                          >
                          <div class="flex items-center gap-3">
                            <label
                              :for="'left-block-image-upload-' + index"
                              class="cursor-pointer text-white bg-green-700 hover:bg-green-800 focus:ring-green-300 rounded-2xl flex flex-row gap-2 items-center justify-center py-2 px-4"
                            >
                              <CloudUpload />
                              Загрузить файл
                            </label>
                            <input
                              :id="'left-block-image-upload-' + index"
                              type="file"
                              class="hidden"
                              @change="handleImageUpload($event, false, index, 'left'); leftBlockFileName = $event.target.files[0]?.name || ''"
                              accept="image/png, image/jpeg, image/webp"
                            />
                            <span
                              x-text="leftBlockFileName || (editingBlock.left.content ? 'Изображение загружено' : 'Файл не выбран')"
                              class="text-sm text-base-content/70"></span>
                          </div>
                          <img
                            x-show="editingBlock.left.content"
                            :src="editingBlock.left.content"
                            alt="Предпросмотр левой колонки"
                            class="rounded-md max-h-48"
                          />
                          <label class="block text-sm font-medium mt-2"
                            >Подпись к изображению</label
                          >
                          <input
                            type="text"
                            x-model="editingBlock.left.caption"
                            class="bg-base-100 border border-base-300 text-base-content text-sm rounded-lg focus:ring-primary focus:border-primary block w-full p-2.5"
                            placeholder="Введите подпись..."
                          />
                        </div>
                      </template>
                    </div>

                    <div
                      class="w-1/2 space-y-3 p-3 border border-base-300 rounded-lg"
                    >
                      <h4 class="text-md font-semibold">Правая колонка</h4>
                      <label class="block text-sm font-medium"
                        >Тип контента</label
                      >
                      <select
                        x-model="editingBlock.right.type"
                        class="bg-base-100 border border-base-300 text-base-content text-sm rounded-lg focus:ring-primary focus:border-primary block w-full p-2.5"
                      >
                        <option value="text">Текст</option>
                        <option value="image">Изображение</option>
                      </select>

                      <template x-if="editingBlock.right.type === 'text'">
                        <div>
                          <label class="block text-sm font-medium">Текст</label>
                          <textarea
                            x-model="editingBlock.right.content"
                            class="bg-base-100 border border-base-300 text-base-content text-sm rounded-lg focus:ring-primary focus:border-primary block w-full p-2.5"
                            rows="5"></textarea>
                        </div>
                      </template>

                      <template x-if="editingBlock.right.type === 'image'">
                        <div
                          x-data="{ rightBlockFileName: '' }"
                          class="space-y-3"
                        >
                          <label class="block text-sm font-medium"
                            >Изображение</label
                          >
                          <div class="flex items-center gap-3">
                            <label
                              :for="'right-block-image-upload-' + index"
                              class="cursor-pointer text-white bg-green-700 hover:bg-green-800 focus:ring-green-300 rounded-2xl flex flex-row gap-2 items-center justify-center py-2 px-4"
                            >
                              <CloudUpload />
                              Загрузить файл
                            </label>
                            <input
                              :id="'right-block-image-upload-' + index"
                              type="file"
                              class="hidden"
                              @change="handleImageUpload($event, false, index, 'right'); rightBlockFileName = $event.target.files[0]?.name || ''"
                              accept="image/png, image/jpeg, image/webp"
                            />
                            <span
                              x-text="rightBlockFileName || (editingBlock.right.content ? 'Изображение загружено' : 'Файл не выбран')"
                              class="text-sm text-base-content/70"></span>
                          </div>
                          <img
                            x-show="editingBlock.right.content"
                            :src="editingBlock.right.content"
                            alt="Предпросмотр правой колонки"
                            class="rounded-md max-h-48"
                          />
                          <label class="block text-sm font-medium mt-2"
                            >Подпись к изображению</label
                          >
                          <input
                            type="text"
                            x-model="editingBlock.right.caption"
                            class="bg-base-100 border border-base-300 text-base-content text-sm rounded-lg focus:ring-primary focus:border-primary block w-full p-2.5"
                            placeholder="Введите подпись..."
                          />
                        </div>
                      </template>
                    </div>
                  </div>
                </div>
              </template>

              <template x-if="editingBlock.type === 'link'">
                <div class="space-y-4">
                  <div>
                    <label class="block text-sm font-medium">Текст ссылки</label>
                    <input
                      type="text"
                      x-model="editingBlock.text"
                      class="bg-base-100 border border-base-300 text-base-content text-sm rounded-lg focus:ring-primary focus:border-primary block w-full p-2.5"
                      placeholder="Введите текст для ссылки..."
                    />
                  </div>
                  <div>
                    <label class="block text-sm font-medium">Тип контента</label>
                    <select
                      x-model="editingBlock.linkedContentType"
                      @change="editingBlock.linkedContentId = ''"
                      class="bg-base-100 border border-base-300 text-base-content text-sm rounded-lg focus:ring-primary focus:border-primary block w-full p-2.5"
                    >
                      <option value="article">Статья</option>
                      <option value="event">Событие</option>
                      <option value="interview">Интервью</option>
                      <option value="flipper">Флиппер</option>
                    </select>
                  </div>
                  <div x-show="editingBlock.linkedContentType">
                    <label class="block text-sm font-medium">Выберите контент</label>
                    <select
                      x-model="editingBlock.linkedContentId"
                      class="bg-base-100 border border-base-300 text-base-content text-sm rounded-lg focus:ring-primary focus:border-primary block w-full p-2.5"
                    >
                      <option value="" disabled>Выберите...</option>
                      <template x-for="item in getFilteredContentList(editingBlock.linkedContentType)" :key="item.id">
                        <option :value="item.id" x-text="item.title"></option>
                      </template>
                    </select>
                  </div>
                </div>
              </template>

              <div class="flex justify-end gap-3">
                <Button variant="accent" @click="cancelEdit()">Отмена</Button>
                <Button variant="success" @click="updateBlock()">Сохранить блок</Button>
              </div>
            </div>
          </template>

          <template x-if="editingIndex !== index">
            <div class="space-y-3">
              <p
                :class="{
                  'text-base': block.type === 'paragraph',
                  'text-lg first-letter:text-4xl first-letter:font-bold': block.type === 'first-paragraph',
                  'text-3xl font-bold': block.type === 'h1',
                  'text-2xl font-semibold': block.type === 'h2',
                  'text-xl font-semibold': block.type === 'h3',
                  'text-lg italic border-l-4 pl-4 my-4 border-base-300': block.type === 'quote'
                }"
                x-text="block.text"
              ></p>

              <template x-if="block.type === 'image'">
                <figure>
                  <img :src="block.url" alt="Содержимое события" class="rounded-md w-full object-cover" />
                  <figcaption class="text-center text-sm text-base-content/60 mt-2" x-text="block.caption"></figcaption>
                </figure>
              </template>

              <div x-show="block.type === 'two-columns'" class="flex flex-col lg:flex-row gap-4 w-full">
                <div class="w-full lg:w-1/2 flex flex-col items-center">
                  <img
                    x-show="block.left?.type === 'image'"
                    :src="block.left?.content"
                    :alt="block.left?.caption || 'Левая колонка'"
                    class="rounded-md max-h-32 object-cover"
                  />
                  <p
                    x-show="block.left?.type === 'text'"
                    x-text="block.left?.content"
                    class="text-sm text-base-content/80"
                  ></p>
                  <span x-show="block.left?.caption" x-text="block.left?.caption" class="text-xs text-base-content/60 mt-1"></span>
                </div>
                <div class="w-full lg:w-1/2 flex flex-col items-center">
                  <img
                    x-show="block.right?.type === 'image'"
                    :src="block.right?.content"
                    :alt="block.right?.caption || 'Правая колонка'"
                    class="rounded-md max-h-32 object-cover"
                  />
                  <p
                    x-show="block.right?.type === 'text'"
                    x-text="block.right?.content"
                    class="text-sm text-base-content/80"
                  ></p>
                  <span x-show="block.right?.caption" x-text="block.right?.caption" class="text-xs text-base-content/60 mt-1"></span>
                </div>
              </div>

              <div class="absolute top-3 right-3 opacity-0 group-hover:opacity-100 transition-opacity flex gap-2">
                <Button variant="outline" size="sm" @click="editBlock(index)">Редактировать</Button>
                <Button variant="error" size="sm" @click="deleteBlock(index)">Удалить</Button>
              </div>
            </div>
          </template>
        </div>
      </template>
    </div>

    <div class="mt-6">
      <template x-if="showBlockOptions">
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 p-4 border border-base-300 rounded-lg bg-base-100">
          <button @click="addBlock('paragraph')" class="btn btn-outline btn-sm justify-start">Обычный абзац</button>
          <button @click="addBlock('first-paragraph')" class="btn btn-outline btn-sm justify-start">Абзац с буквицей</button>
          <button @click="addBlock('h2')" class="btn btn-outline btn-sm justify-start">Подзаголовок H2</button>
          <button @click="addBlock('h3')" class="btn btn-outline btn-sm justify-start">Подзаголовок H3</button>
          <button @click="addBlock('quote')" class="btn btn-outline btn-sm justify-start">Цитата</button>
          <button @click="addBlock('image')" class="btn btn-outline btn-sm justify-start">Картинка</button>
          <button @click="addBlock('two-columns')" class="btn btn-outline btn-sm justify-start">Две колонки</button>
          <button
            @click="addBlock('link')"
            class="btn btn-outline btn-sm justify-start"
            >Блок-ссылка</button
          >
        </div>
      </template>

      <div x-show="!showBlockOptions" class="text-center">
        <Button variant="primary" @click="openBlockSelector()">+ Добавить блок</Button>
      </div>
    </div>
  </section>

  <div class="mt-8 flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
    <div class="flex gap-2">
      {deleteEventId && (
        <button
          type="button"
          class="cursor-pointer text-white bg-red-700 hover:bg-red-800 focus:ring-red-300 flex flex-row items-center justify-center px-4 py-2 rounded-lg"
          @click={`deleteEvent('${deleteRedirect}')`}
        >
          Удалить событие
        </button>
      )}
    </div>
    <div class="flex justify-end gap-3">
      {cancelHref && (
        <a href={cancelHref} class="cursor-pointer text-white bg-yellow-400 hover:bg-yellow-500 focus:ring-yellow-300 flex flex-row items-center justify-center px-4 py-2 rounded-lg">Отмена</a>
      )}
      <Button variant="primary" @click="saveEvent()">{submitLabel}</Button>
    </div>
  </div>
</div>
