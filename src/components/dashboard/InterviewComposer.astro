---
import Button from "@/components/common/Button.astro";
import { CloudUpload } from "lucide-astro";

interface Props {
  heading: string;
  submitLabel: string;
  interviewCreatorState: string;
  cancelHref?: string;
  deleteInterviewId?: string | null;
  deleteRedirect?: string;
}

const {
  heading,
  submitLabel,
  interviewCreatorState,
  cancelHref,
  deleteInterviewId,
  deleteRedirect = "/dashboard/interviews",
} = Astro.props as Props;
---

<div class="max-w-4xl mx-auto" x-data={`$lazy('interviewCreator', ${interviewCreatorState})`}>
  <h1 class="text-3xl font-bold mb-6">{heading}</h1>

  <section class="mb-6 p-6 bg-base-100 border border-base-300 rounded-xl shadow-sm">
    <h2 class="text-xl font-semibold mb-4">Основная информация</h2>

    <label class="block text-sm font-medium text-base-content mb-2">Заголовок интервью</label>
    <template x-if="isEditingTitle">
      <div>
        <input type="text" x-model="editingTitleText" class="bg-base-100 border border-base-300 text-base-content text-sm rounded-lg focus:ring-primary focus:border-primary block w-full p-2.5" />
        <div class="flex justify-end gap-3 mt-3">
          <Button variant="secondary" size="sm" @click="cancelEditTitle()">Отмена</Button>
          <Button variant="primary" size="sm" @click="saveTitle()">Сохранить</Button>
        </div>
      </div>
    </template>
    <template x-if="!isEditingTitle">
      <div class="flex justify-between items-center border border-base-300 rounded-lg px-4 py-3">
        <h3 class="text-lg font-semibold" x-text="interview.title || 'Введите заголовок...'"></h3>
        <Button variant="outline" size="sm" @click="editTitle()">Редактировать</Button>
      </div>
    </template>

    <hr class="my-6" />

    <label class="block text-sm font-medium text-base-content mb-2">Имя интервьюируемого</label>
    <input
      type="text"
      x-model="interview.interviewee"
      class="bg-base-100 border border-base-300 text-base-content text-sm rounded-lg focus:ring-primary focus:border-primary block w-full p-2.5"
      placeholder="Введите полное имя человека, у которого брали интервью"
    />
    <p class="text-xs text-base-content/60 mt-1">Это имя будет отображаться на странице интервью.</p>

    <hr class="my-6" />

    <div class="mt-6">
      <label class="block text-sm font-medium text-base-content mb-3">Теги</label>
      <div class="mt-4 flex flex-col gap-2">
        <div class="flex flex-col sm:flex-row gap-2">
          <input
            type="text"
            x-model="newTagInput"
            class="bg-base-100 border border-base-300 text-base-content text-sm rounded-lg focus:ring-primary focus:border-primary block w-full p-2.5"
            placeholder="Добавь тег латиницей, например 'tech-conference'"
            @keydown.enter.prevent="addCustomTag()"
          />
          <Button variant="outline" size="sm" type="button" @click="addCustomTag()">Добавить тег</Button>
        </div>
        <p class="text-xs text-base-content/60">
          Используй латиницу, так как это значение используется в базе данных.
        </p>
      </div>

      <div class="mt-3 flex flex-col gap-3">
        <template x-if="interview.tags.length > 0">
          <div>
            <p class="text-xs uppercase tracking-[0.2em] text-base-content/60">Выбранные теги</p>
            <div class="flex flex-wrap gap-2 mt-1">
              <template x-for="tag in interview.tags" :key="tag">
                <span class="inline-flex items-center gap-2 px-3 py-1 bg-base-200 rounded-full text-sm">
                  <span x-text="tag"></span>
                  <button
                    type="button"
                    class="text-base-content/60 hover:text-base-content cursor-pointer"
                    @click="removeTag(tag)"
                  >
                    ×
                  </button>
                </span>
              </template>
            </div>
          </div>
        </template>
      </div>
    </div>

    <hr class="my-6" />

    <label class="block text-sm font-medium text-base-content mb-2">Обложка интервью</label>
    <div class="flex items-center" x-data="{ fileName: '' }">
      <label for="file-upload" class="cursor-pointer text-white bg-green-700 hover:bg-green-800 focus:ring-green-300 rounded-2xl flex flex-row gap-2 items-center justify-center py-2 px-4">
        <CloudUpload/>
        Загрузить файл
      </label>
      <input
        id="file-upload"
        type="file"
        class="hidden"
        @change="handleImageUpload($event, true, null); fileName = $event.target.files[0]?.name || ''"
        accept="image/png, image/jpeg, image/webp"
      />
      <span
        x-text="fileName ? fileName : (interview.imageUrl ? 'Изображение загружено' : 'Файл не выбран')"
        class="ml-4 text-sm text-base-content/70"
      ></span>
    </div>
    <div x-show="uploading" class="mt-4">
      <p>Загрузка: <span x-text="uploadProgress.toFixed(2) + '%'"></span></p>
      <div class="w-full bg-base-200 rounded-full h-2">
        <div class="bg-primary h-2 rounded-full" :style="{ width: uploadProgress + '%' }"></div>
      </div>
    </div>
    <div x-show="interview.imageUrl && !uploading" class="mt-4 space-y-4">
      <p class="text-sm text-success">Главное изображение успешно загружено!</p>
      <img :src="interview.imageUrl" alt="Предпросмотр обложки" class="rounded-md max-h-60 w-full object-cover" />
      <div>
        <label class="block text-sm font-medium text-base-content mb-2">Подпись к изображению</label>
        <template x-if="isEditingCaption">
          <div>
            <input
              type="text"
              x-model="editingCaptionText"
              class="bg-base-100 border border-base-300 text-base-content text-sm rounded-lg focus:ring-primary focus:border-primary block w-full p-2.5"
              placeholder="Введите подпись..."
            />
            <div class="flex justify-end gap-3 mt-3">
              <Button variant="secondary" size="sm" @click="cancelEditCaption()">Отмена</Button>
              <Button variant="primary" size="sm" @click="saveCaption()">Сохранить</Button>
            </div>
          </div>
        </template>
        <template x-if="!isEditingCaption">
          <div class="flex justify-between items-center border border-base-300 rounded-lg px-4 py-3">
            <p class="text-base-content" x-text="interview.imageCaption || 'Подпись отсутствует...'"></p>
            <Button variant="outline" size="sm" @click="editCaption()">Редактировать</Button>
          </div>
        </template>
      </div>
    </div>
  </section>

  <section class="p-6 bg-base-100 border border-base-300 rounded-xl shadow-sm">
    <h2 class="text-xl font-semibold mb-4">Содержание интервью</h2>
    <div class="space-y-4">
      <template x-for="(block, index) in interview.contentBlocks" :key="index">
        <div class="p-4 border border-base-300 rounded-lg bg-base-100 relative group">
          <template x-if="editingIndex === index">
            <div class="space-y-4">
              <h3 class="text-lg font-semibold capitalize" x-text="editingBlock.type.replace('-', ' ')"></h3>

              <template x-if="['paragraph', 'first-paragraph', 'h2', 'h3', 'quote'].includes(editingBlock.type)">
                <textarea x-model="editingBlock.text" class="bg-base-100 border border-base-300 text-base-content text-sm rounded-lg focus:ring-primary focus:border-primary block w-full p-2.5" rows="5"></textarea>
              </template>

              <template x-if="editingBlock.type === 'image'">
                <!-- Image block editing UI remains the same -->
              </template>

              <template x-if="editingBlock.type === 'qa'">
                <div class="space-y-3">
                  <label class="block text-sm font-medium">Вопрос</label>
                  <textarea x-model="editingBlock.question" class="bg-base-100 border border-base-300 text-base-content text-sm rounded-lg focus:ring-primary focus:border-primary block w-full p-2.5" rows="3"></textarea>
                  <label class="block text-sm font-medium">Ответ</label>
                  <textarea x-model="editingBlock.answer" class="bg-base-100 border border-base-300 text-base-content text-sm rounded-lg focus:ring-primary focus:border-primary block w-full p-2.5" rows="5"></textarea>
                </div>
              </template>

              <div class="flex justify-end gap-3">
                <Button variant="secondary" @click="cancelEdit()">Отмена</Button>
                <Button variant="primary" @click="updateBlock()">Сохранить блок</Button>
              </div>
            </div>
          </template>

          <template x-if="editingIndex !== index">
            <div class="space-y-3">
              <template x-if="['paragraph', 'first-paragraph', 'h2', 'h3', 'quote'].includes(block.type)">
                <p
                  :class="{
                    'text-base': block.type === 'paragraph',
                    'text-lg first-letter:text-4xl first-letter:font-bold': block.type === 'first-paragraph',
                    'text-2xl font-semibold': block.type === 'h2',
                    'text-xl font-semibold': block.type === 'h3',
                    'text-lg italic border-l-4 pl-4 my-4 border-base-300': block.type === 'quote'
                  }"
                  x-text="block.text"
                ></p>
              </template>

              <template x-if="block.type === 'image'">
                <figure>
                  <img :src="block.url" alt="Содержимое интервью" class="rounded-md w-full object-cover" />
                  <figcaption class="text-center text-sm text-base-content/60 mt-2" x-text="block.caption"></figcaption>
                </figure>
              </template>

              <template x-if="block.type === 'qa'">
                <div class="p-4 bg-base-200/50 rounded-lg">
                  <p class="font-semibold text-lg mb-2">В: <span x-text="block.question"></span></p>
                  <p>О: <span x-text="block.answer"></span></p>
                </div>
              </template>

              <div class="absolute top-3 right-3 opacity-0 group-hover:opacity-100 transition-opacity flex gap-2">
                <Button variant="outline" size="sm" @click="editBlock(index)">Редактировать</Button>
                <Button variant="error" size="sm" @click="deleteBlock(index)">Удалить</Button>
              </div>
            </div>
          </template>
        </div>
      </template>
    </div>

    <div class="mt-6">
      <template x-if="showBlockOptions">
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 p-4 border border-base-300 rounded-lg bg-base-100">
          <button @click="addBlock('paragraph')" class="p-2 rounded-lg cursor-pointer text-gray-900 bg-white border border-gray-300 hover:bg-gray-100 focus:ring-gray-100">Обычный абзац</button>
          <button @click="addBlock('first-paragraph')" class="p-2 rounded-lg cursor-pointer text-gray-900 bg-white border border-gray-300 hover:bg-gray-100 focus:ring-gray-100">Абзац с буквицей</button>
          <button @click="addBlock('h2')" class="p-2 rounded-lg cursor-pointer text-gray-900 bg-white border border-gray-300 hover:bg-gray-100 focus:ring-gray-100">Подзаголовок H2</button>
          <button @click="addBlock('h3')" class="p-2 rounded-lg cursor-pointer text-gray-900 bg-white border border-gray-300 hover:bg-gray-100 focus:ring-gray-100">Подзаголовок H3</button>
          <button @click="addBlock('quote')" class="p-2 rounded-lg cursor-pointer text-gray-900 bg-white border border-gray-300 hover:bg-gray-100 focus:ring-gray-100">Цитата</button>
          <button @click="addBlock('image')" class="p-2 rounded-lg cursor-pointer text-gray-900 bg-white border border-gray-300 hover:bg-gray-100 focus:ring-gray-100">Картинка</button>
          <button @click="addBlock('qa')" class="p-2 rounded-lg cursor-pointer text-gray-900 bg-white border border-gray-300 hover:bg-gray-100 focus:ring-gray-100">Вопрос/Ответ</button>
        </div>
      </template>

      <div x-show="!showBlockOptions" class="text-center">
        <Button variant="primary" @click="openBlockSelector()">+ Добавить блок</Button>
      </div>
    </div>
  </section>

  <div class="mt-8 flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
    <div class="flex gap-2">
      <!-- Delete button logic can be added here if needed -->
    </div>
    <div class="flex justify-end gap-3">
      <!-- Preview button can be added here if needed -->
      {cancelHref && (
        <a href={cancelHref} class="cursor-pointer text-white bg-yellow-400 hover:bg-yellow-500 focus:ring-yellow-300 flex flex-row items-center justify-center px-4 py-2 rounded-lg">Отмена</a>
      )}
      <Button variant="primary" @click="saveInterview()">{submitLabel}</Button>
    </div>
  </div>
</div>
