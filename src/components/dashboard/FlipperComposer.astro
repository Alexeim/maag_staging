---
import Button from "@/components/common/Button.astro";
import { CloudUpload } from "lucide-astro";

interface Props {
  heading?: string;
  submitLabel?: string;
  creatorState: string;
}

const {
  heading = "Создание листалки",
  submitLabel = "Сохранить листалку",
  creatorState,
} = Astro.props;
---

<div class="max-w-4xl mx-auto" x-data={`$lazy('flipperCreator', ${creatorState})`}>
  <h1 class="text-3xl font-bold mb-6">{heading}</h1>

  <section class="mb-6 p-6 bg-base-100 border border-base-300 rounded-xl shadow-sm">
    <h2 class="text-xl font-semibold mb-4">Основная информация</h2>

    <label class="block text-sm font-medium text-base-content mb-2">Заголовок листалки</label>
    <input type="text" x-model="flipper.title" class="bg-base-100 border border-base-300 text-base-content text-sm rounded-lg focus:ring-primary focus:border-primary block w-full p-2.5" placeholder="Введите заголовок..." />

    <hr class="my-6" />

    <label for="category-select" class="block text-sm font-medium text-base-content mb-2">Категория</label>
    <select id="category-select" x-model="flipper.category" @change="handleCategoryChange($event.target.value)" class="bg-base-100 border border-base-300 text-base-content text-sm rounded-lg focus:ring-primary focus:border-primary block w-full p-2.5 cursor-pointer">
      <option value="" disabled>Выберите категорию...</option>
      <option value="culture">Культура</option>
      <option value="paris">Париж</option>
      <option value="news">Новости</option>
    </select>

    <div class="mt-6">
      <label class="block text-sm font-medium text-base-content mb-3">Теги</label>
      <template x-if="getAvailableTags().length > 0">
        <div class="flex flex-wrap gap-2">
          <template x-for="tag in getAvailableTags()" :key="tag.value">
            <button
              type="button"
              class="px-4 py-2 rounded-full border text-sm transition cursor-pointer"
              :class="isTagSelected(tag.value) ? 'bg-primary text-primary-content border-primary' : 'bg-base-100 text-base-content border-base-300 hover:bg-base-200'"
              @click="toggleTag(tag.value)"
              x-text="tag.title"
            ></button>
          </template>
        </div>
      </template>
      <template x-if="getAvailableTags().length === 0">
        <p class="text-sm text-base-content/70">Для выбранной категории пока нет готовых тегов — добавь свои.</p>
      </template>
      <div class="mt-4 flex flex-col gap-2">
        <div class="flex flex-col sm:flex-row gap-2">
          <input type="text" x-model="newTagInput" class="bg-base-100 border border-base-300 text-base-content text-sm rounded-lg focus:ring-primary focus:border-primary block w-full p-2.5" placeholder="Добавь тег латиницей, например art-market" />
          <Button variant="outline" size="sm" type="button" @click="addCustomTag()">Добавить тег</Button>
        </div>
        <p class="text-xs text-base-content/60">Техническое значение тега уходит в базу данных, поэтому используй латиницу.</p>
      </div>
      <div class="mt-3 flex flex-col gap-3">
        <template x-if="flipper.tags.length > 0">
          <div>
            <p class="text-xs uppercase tracking-[0.2em] text-base-content/60">Категорийные теги</p>
            <div class="flex flex-wrap gap-2 mt-1">
              <template x-for="tag in flipper.tags" :key="tag">
                <span class="inline-flex items-center gap-2 px-3 py-1 bg-base-200 rounded-full text-sm">
                  <span x-text="getTagLabel(tag)"></span>
                  <button type="button" class="text-base-content/60 hover:text-base-content cursor-pointer" @click="removeTag(tag)">×</button>
                </span>
              </template>
            </div>
          </div>
        </template>
        <template x-if="flipper.techTags.length > 0">
          <div>
            <p class="text-xs uppercase tracking-[0.2em] text-base-content/60">Техтеги</p>
            <div class="flex flex-wrap gap-2 mt-1">
              <template x-for="tag in flipper.techTags" :key="`tech-${tag}`">
                <span class="inline-flex items-center gap-2 px-3 py-1 bg-base-200 rounded-full text-sm">
                  <span x-text="tag"></span>
                  <button type="button" class="text-base-content/60 hover:text-base-content cursor-pointer" @click="removeTechTag(tag)">×</button>
                </span>
              </template>
            </div>
          </div>
        </template>
      </div>
    </div>
  </section>

  <section class="p-6 bg-base-100 border border-base-300 rounded-xl shadow-sm">
    <h2 class="text-xl font-semibold mb-4">Слайды листалки</h2>
    <div class="space-y-4">
      <template x-for="(item, index) in flipper.carouselContent" :key="index">
        <div class="p-4 border border-base-300 rounded-lg bg-base-100 relative group">
          <h3 class="font-semibold mb-2" x-text="'Слайд ' + (index + 1)"></h3>
          
          <div class="flex items-center" x-data="{ fileName: '' }">
            <label :for="'file-upload-' + index" class="cursor-pointer text-white bg-green-700 hover:bg-green-800 focus:ring-green-300 rounded-2xl flex flex-row gap-2 items-center justify-center py-2 px-4">
              <CloudUpload />
              Загрузить
            </label>
            <input :id="'file-upload-' + index" type="file" class="hidden" @change="handleImageUpload($event, index); fileName = $event.target.files[0]?.name || ''" accept="image/png, image/jpeg, image/webp" />
            <span x-text="fileName ? fileName : (item.imageUrl ? 'Изображение загружено' : 'Файл не выбран')" class="ml-4 text-sm text-base-content/70"></span>
          </div>

          <div x-show="uploading && uploadingIndex === index" class="mt-4">
            <p>Загрузка: <span x-text="uploadProgress.toFixed(2) + '%'"></span></p>
            <div class="w-full bg-base-200 rounded-full h-2">
              <div class="bg-primary h-2 rounded-full" :style="{ width: uploadProgress + '%' }"></div>
            </div>
          </div>

          <div x-show="item.imageUrl && (!uploading || uploadingIndex !== index)" class="mt-4">
            <img :src="item.imageUrl" alt="Предпросмотр" class="rounded-md max-h-48 w-full object-cover" />
          </div>

          <label class="block text-sm font-medium text-base-content mt-4 mb-2">Подпись к слайду</label>
          <textarea x-model="item.caption" class="bg-base-100 border border-base-300 text-base-content text-sm rounded-lg focus:ring-primary focus:border-primary block w-full p-2.5" rows="2" placeholder="Введите подпись..."></textarea>

          <div class="absolute top-3 right-3">
            <Button variant="error" size="sm" @click="removeCarouselItem(index)">Удалить</Button>
          </div>
        </div>
      </template>
    </div>
    <div class="mt-6 text-center">
      <Button variant="primary" @click="addCarouselItem()">+ Добавить слайд</Button>
    </div>
  </section>

  <div class="mt-8 flex justify-end gap-3">
    <Button variant="primary" @click="saveFlipper()">{submitLabel}</Button>
  </div>
</div>